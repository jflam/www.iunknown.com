<!-- Published by Fog Creek Software CityDesk CQSXKDXJHSYDVISL/5193B323/176 -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Fog Creek CityDesk 1.0.1">
<title>IUnknown.com - June 2002 Weblog Archives</title>
<link rel="stylesheet" href="../global.css">
<script type="text/javascript" src="http://www.haloscan.com/load.php?user=jlam"></script>
<script language="javascript">
  function HaloScan2(id) { 
    location.href='http://www.haloscan.com/comments.php?user=jlam&comment='+id;
  }
</script>
</head>
<BODY>

<table border="0" width="800" class="heading">
  <tr>
    <td width="100%" class="heading"><A href="../index.html">IUnknown.com</a></td>
  </tr>
</table>
<table border="0" width="800" class="subheading">
  <tr>
    <td width="100%" class="subheading">    &nbsp; John Lam's weblog on software development</td>
  </tr>
</table>

<table width="800" border="0" cellpadding="7" cellspacing="0">
<tr>
<td class="left_panel" valign="top" align="right">
<p><a href="/rss.xml">rss feed</a></p>
<p>about</p>

<A href="../About/Aboutme.html">About me</a><br>

<A href="../About/fog0000000006.html">About this site</a><br>

<A href="../About/fog0000000010.html">My plan</a><br>

<A href="../About/fog0000000009.html">My other life</a><br>

<A href="../About/fog0000000008.html">My products</a><br>

<A href="../About/fog0000000013.html">My publications</a><br>

<p>aop</p>

<A href="../AOP/fog0000000115.html">My Runtime Aspect Weaver</a><br>

<A href="../AOP/fog0000000114.html">What is AOP?</a><br>

<p>book</p>

<A href="../CLRInternals/fog0000000043.html">About Inside the CLR</a><br>

<p>articles</p>

<A href="../Articles/Booksuggestions.html">Book suggestions</a><br>

<A href="../Articles/fog0000000082.html">Interface dispatch vs. object reference dispatch</a><br>

<A href="../Articles/fog0000000065.html">x86 Resources</a><br>

<A href="../Articles/fog0000000041.html">Entertainment PC's Part 2</a><br>

<A href="../Articles/fog0000000034.html">Entertainment PC's</a><br>

<A href="../Articles/fog0000000025.html">Hello CppUnit</a><br>

<p>archives</p>

<A href="March2003.html">March 2003</a><br>

<A href="February2003.html">February 2003</a><br>

<A href="January2003.html">January 2003</a><br>

<A href="December2002.html">December 2002</a><br>

<A href="November2002.html">November 2002</a><br>

<A href="October2002.html">October 2002</a><br>

<A href="September2002.html">September 2002</a><br>

<A href="August2002.html">August 2002</a><br>

<A href="July2002.html">July 2002</a><br>

<A href="June2002.html">June 2002</a><br>

<A href="May2002.html">May 2002</a><br>

<A href="April2002.html">April 2002</a><br>

<A href="fog0000000116.html">March 2002</a><br>

<A href="fog0000000091.html">February 2002</a><br>

<A href="fog0000000046.html">January 2002</a><br>

<A href="fog0000000030.html">December 2001</a><br>

<a href="http://www.haloscan.com/"><img width="88" height="31" src="http://www.haloscan.com/halolink.gif" border="0" alt="Weblog Commenting by HaloScan.com" /></a> 
</td>
<td class="main_panel">
<p><span class="article_heading">June 2002 Archives</span></p>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/FlexandBison.html">Flex and Bison</A>
  </span><BR>
  29 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P>The time has come, once again, to write yet another parser. Instead of grabbing the latest version of <A href="http://www.sand-stone.com/">Visual Parse++</A> as I've been known to do in the past, I decided to check out Flex and Bison. My requirements this time were fairly basic, and generating C source code is just fine by me. After a bit of hunting around on the Internet, I found this <A href="http://www.monmouth.com/~wstreett/lex-yacc/lex-yacc.html">really nice Win32 port of Flex and Bison</A>. So far so good; everything works as advertised.</P>
    <a href="javascript:HaloScan2('Weblog/FlexandBison.html');"><script type="text/javascript">postCount('Weblog/FlexandBison.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Thank-youMicrosoft.html">Thank-you Microsoft</A>
  </span><BR>
  29 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>Now that I'm back doing the stuff that I love - writing CLAW - I want to publicly thank Microsoft for releasing the Rotor (a.k.a. SSCLI) sources. I am totally amazed that virtually <EM>any</EM> question that I have about the runtime can be answered using the sources. I still have lots of questions; I thought that my prototyping had revealed everything I needed to know, but there are still a few rocks left to turn over.</P>
<P>If you're doing any serious spelunking in the SSCLI sources, you really need a powerful and flexible GREP utility. I highly recommend <A href="http://www.interlog.com/~tcharron/grep.html">Tim Charron's Windows port of GNU Grep 2.0</A>.</P></P>
    <a href="javascript:HaloScan2('Weblog/Thank-youMicrosoft.html');"><script type="text/javascript">postCount('Weblog/Thank-youMicrosoft.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Booksuggestions.html">Book suggestions</A>
  </span><BR>
  29 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I just noticed that <A href="http://www.winterdom.com/weblog/">Tomas Restrepo's</A> <A href="http://www.winterdom.com/weblog/archives/000097.html">graduating with his bachelor's degree</A>. Congratulations!</P>
<P>Tomas also asked for some book recommendations. I <EM>love</EM> recommending books. I decided to write up a few recent favorites of mine, <A href="../Articles/Booksuggestions.html">grouped into different categories</A>.</P></P>
    <a href="javascript:HaloScan2('Weblog/Booksuggestions.html');"><script type="text/javascript">postCount('Weblog/Booksuggestions.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/MethodDescfun.html">MethodDesc fun</A>
  </span><BR>
  28 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>In my <A href="../Weblog/Whatsamethod.html">previous entry</A>, I described my preliminary experiments to discover the true nature of FunctionID's, RuntimeMethodHandles and ModuleID / MethodDef pairs. I described how I figured out that FunctionID's provided by the Profiling API are really just MethodDesc pointers. Here's the evidence that I omitted from that entry. From \clr\src\vm\proftoeeinterfaceimpl.cpp:</P><CODE>
<P>HRESULT ProfToEEInterfaceImpl::GetFunctionInfo( <BR>&nbsp;&nbsp;&nbsp; FunctionID functionId,<BR>&nbsp;&nbsp;&nbsp; ClassID *pClassId,<BR>&nbsp;&nbsp;&nbsp; ModuleID *pModuleId,<BR>&nbsp;&nbsp;&nbsp; mdToken *pToken)<BR>{<BR>&nbsp;&nbsp;&nbsp; MethodDesc *pMDesc = (MethodDesc *) functionId;</P></CODE>
<P>The first line of GetFunctionInfo() says it all ...</P>
<P>&nbsp;</P></P>
    <a href="javascript:HaloScan2('Weblog/MethodDescfun.html');"><script type="text/javascript">postCount('Weblog/MethodDescfun.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/YetanotherupdateonChecked.html">Yet another update on Checked vs. Free builds</A>
  </span><BR>
  28 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><A href="http://www.wintellect.com/about/instructors/robbins/default.asp">John Robbins</A> just informed me that as of Windows XP, Checked builds are no longer built with optimizations disabled. This was deliberately done so that most of the code generated would be identical to that generated by retail builds. However, tracing and assertions are enabled.</P>
    <a href="javascript:HaloScan2('Weblog/YetanotherupdateonChecked.html');"><script type="text/javascript">postCount('Weblog/YetanotherupdateonChecked.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Whatsamethod.html">What's a method?</A>
  </span><BR>
  28 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>This morning, I decided to investigate how the CLR treats methods. First, here's some background information; there are at least three different pieces of information that describe a method in the CLR:</P>
<UL>
<LI>MethodDef tokens describe the <EM>definition</EM> of a method within the scope of the module that it was defined. MethodDef tokens are always scoped by the module in which it was defined. In reality a MethodDef token is simply an the row number of the corresponding entry into the MethodDef table of a module. MethodDef tokens are static data; they are generated at compile time. 
<LI>FunctionID's are provided by the CLR to profilers. The profiler API documentation describes it as&nbsp;"an opaque 32-bit handle". They are used to identify a function that is being called. For example, the ICorProfilerCallback::JITCompilationStarted() callback passes a FunctionID as an in-parameter. FunctionID's are global in scope - that is they are not tied to a specific module.[1] FunctionID's are dynamic data; they are generated at runtime by the CLR. 
<LI>RuntimeMethodHandles are managed structures that are used by the System.Reflection API's to locate a method. Typically you pass a RuntimeMethodHandle to the static MethodInfo.GetMethodFromHandle() method to retrieve a MethodInfo object that corresponds to the runtime method. RuntimeMethodHandles are also dynamic data generated by the CLR.</LI></UL>
<P>There are a number of different ways that you can convert between these values. Some are available if you're using the profiling API's, others are available to you if you're writing IL.</P>
<P>The profiling API's provide some helper methods that let you map a FunctionID to a MethodDef token and a MethodDef token to a FunctionID. These helper methods are ICorProfilerInfo::GetFunctionInfo(), which returns a ModuleID and MethodDef token given a FunctionID, and ICorProfilerInfo::GetFunctionFromToken(), which returns you a FunctionID given a ModuleID and a MethodDef token.</P>
<P>IL lets you retrieve a RuntimeMethodHandle object reference for a MethodDef token <EM>within the currently executing module</EM>, using the ldtoken instruction. This instruction takes a MethodDef token on the call stack and replaces it with a reference to a RuntimeMethodHandle value type.</P>
<P>With that background out of the way, let's get to the point of this entry: Is there a difference between FunctionID's and RuntimeMethodHandles? In the old days, I would figure this out by sending some email to friends at Microsoft who knew how such things behaved. But nowadays there's a much better (and generally faster[2]) way to figure these things out: use the Rotor sources.</P>
<P><A href="http://staff.develop.com/jasonw/">Jason Whittington's</A> <A href="http://msdn.microsoft.com/msdnmag/issues/02/07/SharedSourceCLI/default.asp">Introduction to Rotor article in MSDN</A> helped greatly in getting thins setup and making sense of the Rotor build environment. Once I had a debug build up and running, I started spelunking around inside the SSCLI using the VS.NET debugger. It didn't take much time to figure out that FunctionID's mapped to MethodDesc structs in the CLR. Next, there was a comment in RuntimeMethodHandle.cs that said: "This corresponds to EE MethodDesc.". Hmmm ... it doesn't take a rocket scientist to make the connection, huh?</P>
<P>Just to make sure, though, I also compiled and built a couple of test rigs that would find out for sure. In one case, I used the Reflection API's to scrape out the RuntimeMethodHandle method for a the static Main() method in a console application:</P><CODE>
<P>namespace rmh<BR>{<BR>&nbsp; class Class1<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; [STAThread]<BR>&nbsp;&nbsp;&nbsp; public static void Main(string[] args)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Get a handle to this method</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type class1 = Type.GetType( "rmh.Class1" );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodInfo main = class1.GetMethod( "Main", BindingFlags.Static | BindingFlags.Public );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RuntimeMethodHandle handle = main.MethodHandle;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Handle == {0}", handle.Value );<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</P></CODE>
<P>Then I made a special build of CLAW that dumped out the FunctionID's to the debug console window. The code in question is:</P><CODE>
<P>STDMETHODIMP JITCompilationStarted( FunctionID functionId, BOOL fIsSafeToBlock ) <BR>{ <BR>&nbsp; ATLTRACE( "JIT started on function id = %p", functionId );<BR>&nbsp; return S_OK; <BR>}</P></CODE>
<P>As it turns out, the method handles match up perfectly, thus demonstrating (at least in this case) that a RuntimeMethodHandle's m_ptr field == FunctionID == MethodDesc*.[3]</P>
<P>[1] I'm not currently sure about what the scope of FunctionID's are. They&nbsp;are likely scoped on a per-managed process basis. But I need to do some more experiments to find out for sure.</P>
<P>[2] The email culture at Microsoft is one of getting hundreds of emails a day. If I can help reduce this load, I will, so that I can save up some karma points for help with really difficult questions ;)</P>
<P>[3] Yes, I know I really should have written more code to dump out the method name using the unmanaged metadata API's, but I'll leave that as an exercise for the reader.</P></P>
    <a href="javascript:HaloScan2('Weblog/Whatsamethod.html');"><script type="text/javascript">postCount('Weblog/Whatsamethod.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Softwaredevelopmentproces.html">Software development process</A>
  </span><BR>
  27 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I see that <A href="http://www.quality.nu/dotnetguy/2002/06/26.aspx#a253">Brad Wilson liked what he read</A> in <A href="../Weblog/EffectiveNAnt.html">my Effective NAnt piece</A>. Unfortunately, all of my energies are being focused on building the production version of CLAW. No time for writing (outside of this web log) these days. Sorry ;(</P>
<P>That said, I <EM>highly encourage </EM>Brad to write that book. The community really needs one. After wading through a lot of the literature on automated build tools and automated unit testing tools, I've found that there is absolutely no spine to that story. What I really wanted to see in the literature was something along the lines of: "Here's how to create an automated build / test process, and this is why you should do it this way". </P>
<P>I don't think that I'm asking for all that much, really. But both books that I looked at: Ant: The Definitive Guide, and Java Tools for Extreme Programming are little more than reference / motivational books. They don't tell a good story. They avoid important concepts; for example,&nbsp;neither of them discuss the relationship between Ant and source / version control.</P>
<P>Tell a good, concise story and tell me why your story is what it is. Then drop in a few chapters on advanced, optional components to your story (for example how to integrate unmanaged C++ builds and tools like CppUnit into a NAnt build).</P>
<P>Good luck!</P></P>
    <a href="javascript:HaloScan2('Weblog/Softwaredevelopmentproces.html');"><script type="text/javascript">postCount('Weblog/Softwaredevelopmentproces.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Dynamicpropertyevaluation.html">Dynamic property evaluation in NAnt</A>
  </span><BR>
  27 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>In an earlier post, I commented that NAnt <A href="../Weblog/EffectiveNAnt.html">didn't support dynamic property evaluation</A>. In response to my post, Gerry Shaw, <A href="http://www.geocrawler.com/lists/3/SourceForge/14603/0/9036680/">described what he believed NAnt should be doing</A> with respect to dynamic property evaluation. He believes that&nbsp;NAnt <EM>should be </EM>evaluating properties at run-time. </P>
<P>However, this doesn't turn out to be true in the case of targets; Scott Hernandez replied by <A href="http://www.geocrawler.com/lists/3/SourceForge/14603/0/9038998/">describing how NAnt isn't doing this</A>. The net result of this discussion <A href="http://www.geocrawler.com/lists/3/SourceForge/14603/0/9040708/">is a new bug entered into SourceForge</A>.</P>
<P>I'll continue to describe my experiences with NAnt and other build process / testing tools in my weblog as I encounter them.</P></P>
    <a href="javascript:HaloScan2('Weblog/Dynamicpropertyevaluation.html');"><script type="text/javascript">postCount('Weblog/Dynamicpropertyevaluation.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Updateonfreevs.checkedbui.html">Update on free vs. checked builds</A>
  </span><BR>
  27 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>One of the great things about running a public weblog is that you get tons of input from users. In an <A href="../Weblog/Freevs.checkedbuilds.html">earlier entry</A>, I was wondering what the difference between Checked and Free builds of Windows were. I was under the (mistaken) impression that Checked builds were not really debug builds, but some sort of bizarre hybrid of release + debug settings. </P>
<P>The first reader to respond regarding this was Mattias Haggstrom:</P>
<P><EM>"That's incorrect. Microsoft internally uses the terms free vs checked builds. Free build is also known as release or retail builds while checked builds is another name for debug builds. You might want to read these links:"</EM></P>
<UL>
<LI><A href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/ddtools/hh/ddtools/checked_3lv7.asp?frame=true">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/ddtools/hh/ddtools/checked_3lv7.asp?frame=true</A></LI>
<LI><A href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/gstart/hh/gstart/gs_debug_2inb.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/gstart/hh/gstart/gs_debug_2inb.asp</A> </LI></UL>
<P>No offense intended to Mattias, but I old facts die hard in my brain.&nbsp;Plus, I've got a healthy amount of skepticism towards&nbsp;MSDN documentation,&nbsp;so I took the liberty to ask a few friends about this. The consensus between Matt Pietrek [1], John Robbins, and Jeffrey Richter is that they are all simply debug builds; optimizations are disabled, tracing and assertions are enabled. </P>
<P>[1] Matt's is the only guy I know who can tell what compiler / linker switches you used simply by disassembling the binaries. </P></P>
    <a href="javascript:HaloScan2('Weblog/Updateonfreevs.checkedbui.html');"><script type="text/javascript">postCount('Weblog/Updateonfreevs.checkedbui.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/EffectiveNAnt.html">Effective NAnt</A>
  </span><BR>
  25 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I spent a lot more time than I had wanted to working on the build process for CLAW. In retrospect, I think that I had seriously underestimated the complexities involved in building a fully automated build script. Throw in the learning curve associated with writing NAnt scripts, and then adding a few features to NAnt that I thought were essential and you have all of the ingrediants for a blown schedule ;)</P>
<P>I have finally arrived at a build script that I think I'm happy with. Along the way, however, I made a whole bunch of observations about creating build files that I wanted to collect in one place. This is the purpose of this entry: to try and share a bit of what I learned.</P>
<P><STRONG>Clean and prepare tasks should be separated</STRONG></P>
<P>This is a total non-issue if you are building simple projects that consist entirely of one build file. In this case, combining both operations in the same task is no different than executing each of these tasks separately. </P>
<P>CLAW, however, is built from a series of separate projects. In this case, your clean and prepare tasks must be separated; particularly if you're concerned about maintaining encapsulation in your build files. This is necessary because the clean task is a destructive task, and the prepare task is a constructive task. The tasks need to call nested tasks in <EM>reverse order</EM>. </P>
<P>The clean task must tell all child tasks to clean before it does its own cleaning. This must be done because your child&nbsp;projects will most likely be managing directories underneath the directory that is managed by the master project. You cannot delete a directory that still contains other files / directories; you must clean the child directories before the parent directories.</P>
<P>Similarly, your prepare task must build directories beginning with the master project's directories, followed by the child project's directories.</P>
<P><STRONG>Beware of tri-state builds</STRONG></P>
<P>In NAnt, it's very straightforward to execute either a release build or a debug build by writing tasks that examine the state of a property called, for example, <EM>debug</EM>. The targets would look like:</P><CODE>
<P>&lt;target name="compile-debug" if="${debug}"&gt; ...<BR>&lt;target name="compile-release" unless="${debug}"&gt; ...<BR><BR>&lt;target name="compile"&gt;<BR>&nbsp; &lt;call target="compile-debug"/&gt;<BR>&nbsp; &lt;call target="compile-release"/&gt;<BR>&lt;/target&gt;</P></CODE>
<P>If debug is true, only the compile-debug target will execute. Similarly, if debug is false, only the compile-release target will execute.</P>
<P>But what should you do if you need to build <EM>both</EM> debug and release builds? You might be tempted to create a new target called compile-all. However, if you do this you will wind up with an explosion in the number of targets that you must define. For example, you cannot simply modify a property on the fly within a method; the following code will NOT work:</P><CODE>
<P>&lt;target name="compile"&gt;<BR>&nbsp; &lt;property&nbsp;name="debug" value="true"/&gt;<BR>&nbsp; &lt;call target="compile-debug"/&gt;<BR>&nbsp; &lt;property name="debug" value="false"/&gt;<BR>&nbsp; &lt;call target="compile-release"/&gt;<BR>&lt;/target&gt;</P></CODE>
<P>This is due to the fact that properties are not evaluated during the execution of a task. They are evaluated prior to executing the code within a task.</P>
<P>While there are certainly solutions to this problem, (I'll leave it as an exercise to the reader to figure out the solution), that solution is NOT ideal. Instead, what you should do is define a second property called release. Your code now becomes:</P><CODE>
<P>&lt;target name="compile-debug" if="${debug}"&gt; ...<BR>&lt;target name="compile-release" if="${release}"&gt; ...<BR><BR>&lt;target name="compile"&gt;<BR>&nbsp; &lt;call target="compile-debug"/&gt;<BR>&nbsp; &lt;call target="compile-release"/&gt;<BR>&lt;/target&gt;</P></CODE>
<P>Both targets will compile if&nbsp;the debug and release properties are both set to true.</P>
<P><STRONG>Ensure that your unit tests succeed before checking in your build</STRONG></P>
<P>There is really no point checking in your build if your unit tests fail on that build. Therefore, your unit tests must return a non-zero result if they fail. For example if you were using a CppUnit test harness, your main method should resemble:</P><CODE>
<P>int _tmain(int argc, _TCHAR* argv[])<BR>{<BR>&nbsp; CppUnit::TextUi::TestRunner runner;<BR>&nbsp; runner.addTest( ComTest::suite() );</P>
<P>&nbsp; return runner.run() ? 0: 1;<BR>}</P></CODE>
<P>A non-zero return value will cause an exception to fire inside of NAnt. When this happens you must take appropriate action.</P>
<P>To handle exceptions in NAnt, you must define a property called nant.onfailure and set its value to the name of the target that you want to execute in event of failure. In the case of my build file, I point nant.onfailure to a target that will undo all prior SourceSafe checkout operations.</P></P>
    <a href="javascript:HaloScan2('Weblog/EffectiveNAnt.html');"><script type="text/javascript">postCount('Weblog/EffectiveNAnt.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Statefulvs.statelesstests.html">Stateful vs. stateless tests</A>
  </span><BR>
  23 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I see that <A href="http://radio.weblogs.com/0104813/">Drew</A> <A href="http://radio.weblogs.com/0104813/2002/06/21.html#a81">commented on my CppUnit revisited post</A>, where I was grappling with stateful vs. stateless tests:</P>
<P><EM>"A test method should be completely self contained. It should instantiate all of it's resources and they should be freed at the end. You should not pass resources across test case boundaries.&nbsp;If you need various test methods to perform the same steps, but those steps should vary per test method, then the steps should be coded as private methods which are delegated to by the test method"</EM></P>
<P>Thanks! This makes so much sense to me. </P>
<P>I think I'm going to take a serious look at Drew's <A href="http://sourceforge.net/projects/dotnetunit">.NETUnit testing harness</A> once I get to the managed code portions of CLAW.</P>
<P>I'm still using <A href="http://www.fogcreek.com/CityDesk/">CityDesk</A> to maintain my web log, which is why it took a while for me to respond to Drew's post on his weblog. There are lots of stuff that I really like about CityDesk, but <A href="http://radio.userland.com/">Radio</A> does an awesome job with <A href="http://backend.userland.com/rss092">RSS feeds</A>. </P>
<P>I've actually purchased a copy of Radio, but I've been using it to run a web log for a bunch of 5th graders at a school that I do some volunteer work for here in Toronto. Since that web log is going to shut down this summer, I'm going to spend some more quality time with Radio at that point. I really don't want to give up my CityDesk editor to gain the features of Radio. If there were only some way to combine the features of both into one ...</P></P>
    <a href="javascript:HaloScan2('Weblog/Statefulvs.statelesstests.html');"><script type="text/javascript">postCount('Weblog/Statefulvs.statelesstests.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/CppUnitrevisited.html">CppUnit revisited</A>
  </span><BR>
  21 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I spent some time last night and this morning thinking through some test cases that I'm implementing in <A href="http://sourceforge.net/projects/cppunit">CppUnit</A>. This is all part of my plan to integrate <A href="http://nant.sourceforge.net/">NAnt</A> with CppUnit tests.</P>
<P>Since <A href="../Weblog/HellofromAOSD2002.html">CLAW</A> is a COM object, I needed some tests to verify that it was functioning correctly as a COM object. I needed to execute a suite of tests in a predefined order <EM>against the same COM object</EM>. This gives rise to the concept of stateful vs. stateless test fixtures in CppUnit.</P>
<P>If you follow the excellent CppUnit cookbook, you will wind up with a stateless fixture. Towards the end of the cookbook, the authors encourage you to use a number of macros that are defined in the cppunit\extensions\HelperMacros.h header file. They recommend that you registering a number of tests with a test suite can using:</P><CODE>CPPUNIT_TEST_SUITE( StatelessComTest );<BR>&nbsp; CPPUNIT_TEST( testCreateInstance );<BR>&nbsp; CPPUNIT_TEST( testInitialize );<BR>&nbsp; CPPUNIT_TEST( testShutDown );<BR>CPPUNIT_TEST_SUITE_END();<BR></CODE>
<P>However, the problem with this approach is that it will construct separate StatelessComTest objects for each one of the three tests being run: testCreateInstance, testInitialize, testShutDown. This effectively prevents you from sharing the same COM object instance across all three tests. </P>
<P>The macros shown above construct a method that resembles:</P><CODE>
<P>static Test *suite() <BR>{<BR>&nbsp; TestSuite *testSuite = new TestSuite();<BR>&nbsp; testSuite-&gt;addTest( new TestCaller&lt; StatelessComTest &gt;( "testCreateInstance", testCreateInstance ) );<BR>&nbsp; ...<BR>}</P></CODE>
<P>Each call to TestSuite::addTest() adds a separate object to the suite. This is not acceptable if&nbsp;you want to invokve a number of methods on the same COM object; you'll need to keep it hanging around.</P>
<P>To solve this problem, you need to implement an instance method called suite() as opposed to the static method shown above:</P><CODE>
<P>Test *suite()<BR>{<BR>&nbsp; TestSuite *testSuite = new TestSuite( "StatefulComTest" );<BR>&nbsp; testSuite-&gt;addTest( new TestCaller&lt; StatefulComTest &gt;( "testCreateInstance", testCreateInstance, *this ) );<BR>&nbsp; testSuite-&gt;addTest( new TestCaller&lt; StatefulComTest &gt;( "testInitialize", testInitialize, *this ) );<BR>&nbsp; testSuite-&gt;addTest( new TestCaller&lt; StatefulComTest &gt;( "testShutDown", testShutDown, *this ) )<BR>&nbsp; return testSuite;<BR>}</P></CODE>
<P>In this method, notice that *this is passed as the last parameter to TestCaller's constructor. This ensures that the <EM>same</EM> StatefulComTest object is called for all three tests.</P>
<P>The next question that naturally arises is where to construct the instance of the COM object that will be shared. The correct solution is in the constructor of the StatefulComTest object. You might be tempted to use the setUp()&nbsp; and tearDown() methods, but you must remember that these methods are called before and after each test in your test suite, regardless of whether the tests are run on the same object or not!</P>
<P>If you're interested in looking at some sample code that illustrates these points, <A href="../Files/COMTest.h">click here</A> to view the C++ header file for the tests.</P>
<P><STRONG>Update</STRONG>: You can't really use the constructor /destructor to setup and tear down the COM object either since you'd be tempted to throw exceptions from there. Unfortunately, CppUnit (1.8.0 is the build that I'm using) does not catch any thrown exceptions from TestFixture constructors, so they leak. </P>
<P>I'm currently investigating how to work around this. I suspect that each test must be stateful, and maintaining state across tests is just <EM>not the way to do things</EM> using CppUnit.</P></P>
    <a href="javascript:HaloScan2('Weblog/CppUnitrevisited.html');"><script type="text/javascript">postCount('Weblog/CppUnitrevisited.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Generatingbuildreports.html">Generating build reports</A>
  </span><BR>
  20 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>While writing the build script to handle release builds, I realized the need to capture build reports separately from the build artifacts. To this end, I've created a directory tree structure that resembles:</P><CODE>
<P>app<BR>+--build<BR>&nbsp; &nbsp;+--debug<BR>&nbsp; &nbsp;+--release<BR>+--reports<BR>+--setup<BR>+--src</P></CODE>
<P>The reports directory contains various pieces of information related to the build. I'm going to drop the output of CppUnit / NUnit into this directory (which is under version control). </P>
<P>One other piece of information that I'm going to drop in here is the linker MAP file. After re-reading some of John Robbins' earlier work on this stuff, I've gotten the MAP religion. For those of you who need a refresher course on MAP files and how they help you find bugs in code that you've shipped, you should read:</P>
<OL>
<LI>
<DIV>John's <A href="http://msdn.microsoft.com/library/en-us/dnmsj99/bugslayer1099.htm">original BugSlayer column</A> that describes MAP files.</DIV>
<LI>
<DIV>John's BugSlayer column that describes a utility that he wrote: <A href="http://msdn.microsoft.com/msdnmag/issues/0400/bugslayer/bugslayer0400.asp">PDB2MAP</A> that generates MAP files from PDB files. </DIV>
<LI>
<DIV>Read Chapter 8 of <A href="http://www.amazon.com/exec/obidos/ASIN/0735608865/iunknowncom-20/">John's book</A>&nbsp;which talks about how MAP files can be used either manually or with John's <A href="http://www.wintellect.com/about/instructors/robbins/code.asp">CrashFinder</A>&nbsp;utility.</DIV></LI></OL></P>
    <a href="javascript:HaloScan2('Weblog/Generatingbuildreports.html');"><script type="text/javascript">postCount('Weblog/Generatingbuildreports.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Freevs.checkedbuilds.html">Free vs. checked builds</A>
  </span><BR>
  20 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P>We all know that Microsoft ships versions of the operating system as Free and Checked builds. My understanding is that both of these builds are compiled using release compiler / linker options, but the Checked builds have additional debugging / parameter validation code inside of them. Can anyone <A href="mailto:jlam@iunknown.com">shed any light</A> on what the differences between Free and Checked code looks like using a simple example? </P>
    <a href="javascript:HaloScan2('Weblog/Freevs.checkedbuilds.html');"><script type="text/javascript">postCount('Weblog/Freevs.checkedbuilds.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Buildscriptsanddebugrelea.html">Build scripts and debug / release builds</A>
  </span><BR>
  20 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I've been thinking a lot more about build scripts this morning now that I've successfully integrated NSIS with NAnt. Today is the CppUnit / NUnit integration day.</P>
<P>As I started generalizing my *daily* build script to handle both debug and release builds, several issues immediately popped to the forefront (thankfully mostly due to directory naming issues!) Here they are, in no particular order:</P>
<UL>
<LI>In my daily build, do I generate both debug and release builds?</LI>
<LI>Do I run unit tests on both my debug and release builds?</LI>
<LI>Should I check in the .EXE's and .DLL's generated for each build?</LI>
<LI>Do I bother generating distribution media (my NSIS .EXE) for both debug and release builds?</LI></UL>
<P>Right now, these are the solutions that I'm leaning towards (and have coded the script to):</P>
<UL>
<LI>Generate both debug and release builds.</LI>
<LI>Run unit tests against both builds - question to answer: same unit tests&nbsp;or subtly different ones - for example, release unit tests could have performance constraint criteria built into the tests (e.g. take less than n seconds to complete a test).</LI>
<LI>Check in the .EXE's and .DLL's generated by each build - I was tempted to leave these out since I label each daily build anyways, but these capture some configuration informatoin such as the version of the compiler used to generate them.</LI>
<LI>Don't generate distribution media - make this a separate target called build-deploy</LI></UL>
<P><A href="mailto:jlam@iunknown.com">Comments</A> are always welcome. Yes, yes, I know, I need to add a comment server ... ;)</P></P>
    <a href="javascript:HaloScan2('Weblog/Buildscriptsanddebugrelea.html');"><script type="text/javascript">postCount('Weblog/Buildscriptsanddebugrelea.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/FunwithNSIS.html">Fun with NSIS</A>
  </span><BR>
  19 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I spent the better part of this morning working on the installer for CLAW. There's not a lot that needs to be done: my requirements are fairly simple:</P>
<UL>
<LI>Must be scriptable from a NAnt build script</LI>
<LI>Must support silent installs / uninstalls (especially for smoke testing)</LI>
<LI>Must be able to register / unregister COM objects</LI>
<LI>Must be able to add the appropriate variables into the global environment block to enable the profiler</LI></UL>
<P>I was quite disappointed by my ancient copy of <A href="http://www.wise.com">WISE 6.0</A>. It doesn't appear to be callable from a build script. So I punted it. After asking around a bit on some mailing lists that I belong to, <A href="http://www.quality.nu/dotnetguy/">Brad Wilson</A> told me that Wise 8.1 supported command line installer building. The problem is that I didn't really want to pay $450 for yet another installer package; particularly since my needs are so simple.</P>
<P>After a bit more looking around, I discovered <A href="http://www.nullsoft.com/free/nsis/">NSIS</A>. This is the Nullsoft Installation System (yes, brought to you by the same folks that created WinAmp). It's a free&nbsp;open-source installation system with quite a flexible scripting language built in. It also comes with a simple command-line compiler: makensis. </P>
<P>NSIS generates single-file installs. It supports uninstalls as well. It had support for every single one of my requirements except for the last one. However, it's a fairly simple task to add some additional code into a call to DllRegisterServer to add the appropriate variables to the global environment block. I'm off to the races!</P>
<P>If you're interested in checking out what an NSIS script looks like, <A href="../Files/claw_setup.nsi">click here</A>.</P></P>
    <a href="javascript:HaloScan2('Weblog/FunwithNSIS.html');"><script type="text/javascript">postCount('Weblog/FunwithNSIS.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/MoreC++andNAntstuff.html">More C++ and NAnt stuff</A>
  </span><BR>
  19 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>One of the great things about having a weblog and living your (professional) life through it is the incredible amount of help that you can get with your problems. Within a few hours of posting my entry on creating C++ build scripts with NAnt, I got messages from <A href="http://www.winterdom.com/me/aboutme.html">Tomas Restrepo</A> and <A href="http://www.wintellect.com/about/instructors/robbins/default.asp">John Robbins</A>&nbsp;that helped me solve my problems with precompiled headers. </P>
<P>John summarized the solution the best: </P>
<UL>
<LI>Use /Yc on the STDAFX.CPP file.&nbsp; 
<LI>Use /Yu on all other .CPP files. </LI></UL>
<P>Fortunately, these rules are really easy to capture using the cl task in NAnt:</P><CODE>
<P>&lt;cl outputdir="${build}" pchfile="Weaver.pch" options='/Yc"stdafx.h" ...'&gt;<BR>&nbsp; &lt;sources&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;includes name="stdafx.cpp"/&gt;<BR>&nbsp; &lt;/sources&gt;<BR>&lt;/cl&gt;</P>
<P>&lt;cl outputdir="${build}" pchfile="Weaver.pch" options='/Yu"stdafx.h" ...'&gt;<BR>&nbsp; &lt;sources&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;excludes name="stdafx.cpp"/&gt;<BR>&nbsp;&nbsp;&nbsp; &lt;includes name="*.cpp"/&gt;<BR>&nbsp; &lt;/sources&gt;<BR>&lt;/cl&gt;</P></CODE>
<P>Tomas helped out with a <A href="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/nantcontrib/NAntContrib/src/Tasks/">pointer to NAntContrib</A>, which is&nbsp;where the community is dropping additional tasks into SourceForge. I downloaded RcTask.cs, which is a task that contains support for calling rc.exe.&nbsp;This lets me write:</P><CODE>
<P>&lt;rc rcfile='Weaver.rc' output='${build}\Weaver.res' options='/d "_DEBUG" /l 0x409 /I "${build}"'/&gt;</P></CODE>
<P>to compile&nbsp;my resource scripts.&nbsp;What RcTask is missing, however, is dependency checking. I'll look into adding that support later tonight.</P>
<P>I've updated my simple ATL build script to reflect my newfound understanding. You can <A href="../Files/simple_atl_default.build">click here</A> to download it.&nbsp;</P></P>
    <a href="javascript:HaloScan2('Weblog/MoreC++andNAntstuff.html');"><script type="text/javascript">postCount('Weblog/MoreC++andNAntstuff.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/BuildingC++projectswithNA.html">Building C++ projects with NAnt</A>
  </span><BR>
  18 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>Now that I've more-or-less figured out how to build C# projects using NAnt, I'm turning to the real meat of my development process: compiling C++ projects. In theory, it should be no different from using the csc task in NAnt. The reality, however, is that the C++ compiler has a lot more knobs and switches that you can and should flip while doing development. </P>
<P>There are two unique challenges in creating a NAnt build file that works correctly with C++ projects. The first is making sure that all of your favorite CL.EXE command line options are set correctly. However, if you're like me and were raised in IDE's, this can be a really daunting task. However, the VS.NET IDE has a savior: the build log. If you look at the build log, you'll see the actual command lines that were used by VS.NET to compile your application. This makes it considerably easier to replicate your VS.NET build inside of a NAnt build file.</P>
<P>The second is doing all of those little things that we take for granted in ATL projects. Things like running the MIDL compiler or registering your COM DLL's using regsvr32.exe. Fortunately, these commands are captured using the VS.NET build log as well, so it's mostly a matter of patience and typing to get these things integrated into your NAnt build file.</P>
<P>To this end, I'm doing the NAnt equivalent of "Hello, World" for an ATL project in VS.NET. This is a simple AppWizard generated ATL skeleton project.</P>
<P>WATCH OUT FOR DOUBLE QUOTES! Most command line options contain double quoted filenames. Most people like to use double quotes to delimit their XML attribute values (I know I do). This is a very, very bad mix in NAnt build files. Make sure that you use single quotes to delimit your attribute values so that you can continue to use double quotes in your command line options. If you change your command line options to use single quotes, you will get tons of unexplainable errors in your build scripts. </P>
<P>If you want to take a peek at this work in progress, <A href="../Files/simple_atl_default.build">click here</A>. There's still a bunch of things that I need to change in this build script. Most notably, none of my fun versioning / VSS stuff&nbsp;lives in this file. But I managed to get a simple script that&nbsp;compiles a debug build of an ATL project up and running.&nbsp;After working with this script a bit, I realize that there's a few&nbsp;additional features that would make NAnt better:</P>
<OL>
<LI>
<DIV>A way of defining symbols in something that resembles a NAnt fileset. Defining them on the command line is really awkward.</DIV>
<LI>
<DIV>Additional tasks for running&nbsp;midl.exe and&nbsp;rc.exe that does some dependency checking.</DIV></LI></OL>
<P>These are fairly low-priority items right now since the exec task provides a reasonable, albeit sub-optimal workaround.</P>
<P>One other thing that I never got working was the /Yc and /Yu options for controlling the generation / use of precompiled headers. If you look closely at the build script, you'll notice that I used the /YX option to let cl.exe figure out what to do about precompiled headers. <A href="mailto:jlam@iunknown.com">I'd be interested in hearing</A> whether /Yc + /Yu is preferable to using /YX. <STRONG>Update:</STRONG> I've <A href="../Weblog/MoreC++andNAntstuff.html">posted a new entry</A> that shows how this problem was solved.</P>
<P>Next up is to make these scripts work on release and debug builds to capture the most commonly used options. </P></P>
    <a href="javascript:HaloScan2('Weblog/BuildingC++projectswithNA.html');"><script type="text/javascript">postCount('Weblog/BuildingC++projectswithNA.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/RevisedNAntVersionTask.html">Revised VersionTask</A>
  </span><BR>
  18 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I spent a bit more time this morning thinking about the VersionTask code. I decided that the way that I calculated the Revision Number (a.k.a. PrivatePart of the FILEVERSIONINFO) wasn't flexible enough. I wanted not only to have a mechanism where I auto-generated that number based on the number of seconds since the start of the day / 10, but I also wanted to be able to increment that number. </P>
<P>It became obvious to me that the ability to increment the revision number becomes important once you ship code. If you're going to continue to patch existing code by releasing service packs, you need to keep the build number constant, but increment the revision number. </P>
<P>This also requires that you branch the source tree, and I can't really think of a way to capture that in the NAnt build script automatically. I added the ability to freeze a build number by allowing you to specify "noincrement" for the buildtype attribute. However, you still need to manually specify this in your build file when you branch the source tree to handle revisions to that shipping version.</P>
<P>To support this new feature, I needed to persist the version information structure back to the build.number file regardless of which algorithm you used to generate the build number. However, this also requires that the build.number file get checked into your source control system, and requires your build script to explicitly check out and check back in the build.number file. </P>
<P>I added these new features to the VersionTask.cs file that I shipped yesterday. This file <EM>replaces </EM>the old file that was there before. Among the things that I did were to clean up some names of methods to more accurately reflect what they did. I now distinguish explicitly between:</P>
<OL>
<LI>Version number = major.minor,build.revsion (as a string)</LI>
<LI>Build number = the third octet in the version number</LI>
<LI>Revision number = the fourth octet in the version number</LI></OL>
<P>I added ways for you to specify the semantics for the build number:</P>
<OL>
<LI>monthday = calculate the build number based on the # months since the start of the project * 100 + the current day of the current month</LI>
<LI>increment = increment the build number each time you build</LI>
<LI>noincrement = freeze the build number - this is used only for cases where you have shipped the code and wish to freeze. </LI></OL>
<P>I added ways for you to specify the semantics for the revision number:</P>
<OL>
<LI>automatic = calculate the revision number based on the # seconds since the start of the day / 10</LI>
<LI>increment = increment the revision number each time you build during the same day. This assumes that you're using the monthday build number algorithm. If you're using the increment build number algorithm, this value is ALWAYS 0 - as it will be if you roll over to a new day in using the monthday algorithm.</LI></OL>
<P><A href="../Files/VersionTask.cs">Click here</A> to grab the new source file.</P></P>
    <a href="javascript:HaloScan2('Weblog/RevisedNAntVersionTask.html');"><script type="text/javascript">postCount('Weblog/RevisedNAntVersionTask.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/NAntBuildNumbersandVisual.html">NAnt, Build Numbers and Visual SourceSafe</A>
  </span><BR>
  17 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I've been spending some quality time with <A href="http://nant.sourceforge.net/">NAnt</A> over the past couple of days. I'm putting together a comprehensive set of build scripts that I'll be using to build CLAW. The first set(s) of problems that I decided to tackle are related to the build process, build numbers, and <A href="http://msdn.microsoft.com/ssafe/">Visual SourceSafe</A> integration.</P>
<P>I've spent quite a bit of time reading various bits and pieces of documentation about N/Ant. What drives me crazy about all of the documentation that I've read is that none of them pay any serious attention to version control and build numbers. These two issues are critical in any software development process, particularly once you into situations where many different builds of your software can be found "in the wild".</P>
<P>I have two very simple requirements for my NAnt script:</P>
<OL>
<LI>For my daily build scenarios, I want to have the script auto-generate a new build number, get the latest source code files from VSS, compile everything, check the compilation artifiacts (DLL's, EXE's, PDB's) back into VSS, and label everything using that build number. 
<LI>For debugging scenarios, I want to be able to re-build any version of my code. This involes getting the source code files that correspond to Version X, and compile everything. </LI></OL>
<P>The first thing that I had to do was implement a new NAnt task that will auto-generate build numbers at runtime. The build number is the third octet in a typical 64-bit FILEVERSION version number: major.minor.build_number.revsion_number.</P>
<P>My VersionTask implementation can use one of two algorithms to generate build numbers. The first algorithm simply increments the build number field of a FILEVERSION version number that can be found in the build.number file that resides in the same directory as the NAnt build file. </P>
<P>The second algorithm calculates a 4 digit build number. The first two digits are the number of months since the start of the project, and the last two digits are the current day. This is identical to the build number algorithm used by the .NET Frameworks team. </P>
<P>If you're interested in looking at my alpha code for my VersionTask implementation, you can <A href="../Files/VersionTask.cs">download it</A>. Note that I revised this code since this message. See <A href="../Weblog/RevisedNAntVersionTask.html">the updated entry</A> in my weblog.</P>
<P>I also wanted to stamp the FILEVERSION of my file using the auto-generated build number. To make this happen, I need to inject the build number into an AssemblyInfo.cs file that would resemble:</P><CODE>
<P>using System.Reflection;<BR>using System.Runtime.CompilerServices;</P>
<P>[ assembly: AssemblyFileVersion( "@version@" ) ]</P></CODE>
<P>Note that I'm using an AssemblyFileVersion attribute to stamp the FILEVERSION resource in the generated assembly. Also notice that the version ID is encoded as "@version@". To make this happen, I needed to implement <A href="http://jakarta.apache.org/ant/manual/CoreTasks/filter.html">Ant's filtering capabilities</A>.</P>
<P>The way I structured my build file, I checked the above file into VSS as AssemblyInfo.txt. Next, I defined a filter for the version number:</P><CODE>
<P>&lt;filter token="version" value="${sys.version}"/&gt;</P></CODE>
<P>Then, I used my modified CopyTask to generate the AssemblyInfo.cs file:</P><CODE>
<P>&lt;copy file="${src}\AssemblyInfo.txt" tofile="${src}\AssemblyInfo.cs" filtered="true"/&gt;</P></CODE>
<P>Note that the filtered attribute is set to true. In this case, I read the entire file into memory, and use Regex.Replace to replace all occurrances of the @version@ token with the version ID property.</P>
<P>If you're interested in taking a peek at the code that I wrote to make this all possible in NAnt, you can download the bits <A href="../Files/JohnModifiedNAnt.zip">from here</A>. I'll be testing these bits for a while first before submitting them to the good folks on the NAnt dev team for inclusion in the real distribution. Special thanks go out to <A href="http://nant.sourceforge.net/authors.html">Scott Hernandez</A>, who patiently answered a number of dumb NAnt questions that I sent him.</P></P>
    <a href="javascript:HaloScan2('Weblog/NAntBuildNumbersandVisual.html');"><script type="text/javascript">postCount('Weblog/NAntBuildNumbersandVisual.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Newbooks.html">New books</A>
  </span><BR>
  17 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I received my autographed copy of <A href="http://www.wintellect.com/about/instructors/prosise/default.asp">Jeff Prosise's</A> <A href="http://www.amazon.com/exec/obidos/ASIN/0735613761/iunknowncom-20">Programming .NET</A> in the mail last week. Jeff co-authored the initial version of our <A href="http://www.wintellect.com/seminars/training.aspx?courses=1&amp;id=3">Programming ASP.NET</A> class for <A href="http://www.wintellect.com">Wintellect</A>. This book largely reflects the story that we tell in that class. In reading through the printed version of the book, I'm totally amazed at the clarity with which Jeff writes. He makes the rest of us look so mediocre in comparison. Congratulations, Jeff!</P>
<P>I also went out and picked up a copy of <A href="http://staff.develop.com/bobb/">Bob Beauchemin's</A> <A href="http://www.amazon.com/exec/obidos/ASIN/0201758660/iunknowncom-20">Essential ADO.NET</A>. Bob is the guy that I turn to for all of my data access related questions. Bob has forgotten more about data access than most of us will ever know. Bob's book explains the why's and how's of data access with remarkable clarity. There's a great story in this book, that builds from a historical introduction that places ADO.NET in context with all of the other "last data access API's that you'll ever need to know". Highly recommended for anyone doing data access on .NET. Note to self: I must get Bob to autograph my copy too ... ;)</P></P>
    <a href="javascript:HaloScan2('Weblog/Newbooks.html');"><script type="text/javascript">postCount('Weblog/Newbooks.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Productioncode.html">Production code!</A>
  </span><BR>
  17 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>The prototyping phase is over. I'm starting to drive <A href="../Weblog/HellofromAOSD2002.html">CLAW</A> towards production quality code now. I spent the better part of the weekend getting my ducks in a row: building my <A href="http://nant.sourceforge.net/">NAnt</A> scripts, implementing some custom NAnt tasks so that I can generate the version numbers that I need, building my skeleton <A href="http://sourceforge.net/projects/cppunit">CppUnit</A> tests, and researching offsite backup solutions.</P>
<P>I'm also going to spend some time this week researching testing solutions. While I'm not yet at the point where I have enough pieces integrated together in CLAW to do much more than run unit tests, I'm anticipating the day where I can start deploying the production bits to <A href="http://www.vmware.com">VMWare</A> machines and running unit / smoke tests on each box. Any tips and suggestions on how this can / should be done would be <A href="mailto:jlam@iunknown.com">greatly appreciated</A>.</P></P>
    <a href="javascript:HaloScan2('Weblog/Productioncode.html');"><script type="text/javascript">postCount('Weblog/Productioncode.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/Toronto.NETUsersGroup.html">Toronto .NET User's Group</A>
  </span><BR>
  12 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>I gave a couple of fun talks at the <A href="http://www.dnugtor.com">Toronto .NET User's group</A> last night. The first talk was an overview of the CLR, where the different technologies (CLR, ASP.NET, ADO.NET, SOAP / WebServices, WinForms, VS.NET) fit into the big picture, followed by an examination of a couple of useful tools (<A href="http://www.saurik.com/net/exemplar/">Anakrino</A> and <A href="http://www.aisto.com/roeder/dotnet/">Reflector</A>) for examining compiled assemblies.</P>
<P>The second talk was a talk about <A href="../Weblog/HellofromAOSD2002.html">CLAW</A>. In this talk, I presented the current implementation of CLAW, and of course, for the first time ever, my demo blew up. Thanks to Ed Musters for distracting the audience while I attempted to figure out what was wrong. Normally I can figure out what is wrong, but in this case I couldn't get it working. </P>
<P>This morning, while waiting for my car to be serviced, it took me all of 5 minutes to figure out the problem: I installed the ASP.NET hotfix. Apparently, when a Microsoft hotfix installs, it also re-NGEN previously compiled assemblies. For CLAW to work on NGEN'ed assemblies, they must be NGEN'ed with the /prof command line switch. The two key assemblies that would have made my demos work: System.Xml.dll and System.Windows.Forms.dll were not NGEN'ed with /prof, so bam the demo blew up.</P>
<P>My thanks go out to the audience for being patient while I flailed around on stage, and for using their imaginations when I described what <EM>should have</EM> happened. </P>
<P>Here's <A href="../Files/TorontoDotNetJune11.zip">a ZIP file</A> that contains both power point presentations that I gave at the talk.</P></P>
    <a href="javascript:HaloScan2('Weblog/Toronto.NETUsersGroup.html');"><script type="text/javascript">postCount('Weblog/Toronto.NETUsersGroup.html');</script></a>
  </BLOCKQUOTE>
      <P></P>
 
<P>
  <span class="article_heading">
    <A href="../Weblog/HostingASP.NETinaWinForms.html">Hosting ASP.NET in a WinForms app</A>
  </span><BR>
  07 Jun, 2002

  <BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
    <P><P>This entry doesn't have anything to do with aspect-oriented programming. I'm on my way back home after teaching my ASP.NET class to the nice folks at <A href="http://www.unumprovident.com/">UNUM Provident</A> in Portland, Maine. After missing my connecting flight at LaGuardia, I'm sitting in the United Lounge writing this piece on my experiences with hosting ASP.NET inside of a WinForms application.</P>
<P>Before I begin, let me explain why I'm interested in hosting ASP.NET inside of a WinForms app. One of the things that I like to do (when I have the energy) is to go out and take pictures of the area around where I happen to be teaching a class. I've got a fair collection of digital photographs from lots of different places, and I'd like to publish them on this web site. However, what has always frustrated me was the difficulty in creating what amounts to a photo essay using traditional web logging tools such as the one that I'm using to create this entry.</P>
<P>I've been itching to write a WinForms app, and I've been itching to learn the syntax of VB.NET, so I decided to write an app that will let me create photo essays. The concept is real simple: let a user select a bunch of digital photographs, let them annotate those photographs with text, and let them publish the generated photo essay to a web server as a collection of static HTML pages and images. There are several other requirements that I have for my application:</P>
<UL>
<LI>It will automatically resize my pictures and generate thumbnails, as well as several other differently sized versions of the same picture. 
<LI>It will let me publish my photo essay using arbitrary templates written using ASP.NET. 
<LI>It will save the photo essay in a MSDE database.</LI></UL>
<P>Hosting ASP.NET turns out to be ridiculously simple. At first, I first tried to do it the hard way: I derived my own class from System.Web.HttpWorkerRequest. This led to all sorts of frustration. Thankfully, while I was teaching my class up in Portland, <A href="http://staff.develop.com/onion/resources.htm">Fritz Onion</A> and I hung out one evening after the <A href="http://www.mainebytes.com">MaineBytes</A> user group meeting that Fritz spoke at. Fritz pointed that I really should be using System.Web.Hosting.SimpleWorkerRequest in my hosting scenario. He also sent along some sample code that illustrated this. Wow. That changed everything. In 5 minutes I had ASP.NET hosted inside of my application.</P>
<P>Here's the sample code that Fritz sent along:</P><CODE>
<P>using System;<BR>using System.IO;<BR>using System.Web;<BR>using System.Web.Hosting;</P>
<P>public class MyExeHost : MarshalByRefObject<BR>{<BR>&nbsp; public void ProcessRequest(String page)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; HttpWorkerRequest hwr = <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new SimpleWorkerRequest(page, null, Console.Out);<BR>&nbsp;&nbsp;&nbsp; HttpRuntime.ProcessRequest(hwr);<BR>&nbsp; }<BR>}</P>
<P>public class App<BR>{<BR>&nbsp; public static void Main(string[] args)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; MyExeHost host = (MyExeHost)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationHost.CreateApplicationHost(typeof(MyExeHost), "/",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Directory.GetCurrentDirectory());<BR>&nbsp;&nbsp;&nbsp; foreach (String page in args)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; host.ProcessRequest(page);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</P></CODE>
<P>While Fritz's code got me most of the way to my solution, one other thing that I needed to do was to have my ASP.NET host add some additional objects to the HttpContext. One of the objects that I wanted to add was a DataSet object that would contain the list of images and their associated text. This would let the ASP.NET page databind against that DataSet to generate the final list / set of images.</P>
<P>To make this work, I need to intercept the creation of the HttpContext object and add my DataSet object to the HttpContext object. This required me to derive a custom handler from the System.Web.SimpleWorkerRequest class. The key method that I need to override was the SetEndOfSendNotification method. In this method, the extraData parameter will contain the newly created HttpContext object. Here's the code that makes this possible:</P><CODE>
<P>public class CustomWorkerRequest : SimpleWorkerRequest<BR>{<BR>&nbsp; public CustomWorkerRequest( string page, string query, TextWriter writer ) : base( page, query, writer ) {}</P>
<P>&nbsp; public override void SetEndOfSendNotification( EndOfSendNotification callback, object extraData ) <BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; base.SetEndOfSendNotification( callback, extraData );</P>
<P>&nbsp;&nbsp;&nbsp; HttpContext context = extraData as HttpContext;<BR>&nbsp;&nbsp;&nbsp; if( context != null )<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // TODO: add a reference to a DataSet object here that would contain<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // the data to be injected into the web page. The web page will databind<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // against this DataSet to generate the photoesssay HTML<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</P></CODE>
<P>Hopefully this helps anyone else walking down this path. Feel free to <A href="mailto:jlam@iunknown.com">send me some email</A> if you have comments / questions / suggestions.</P></P>
    <a href="javascript:HaloScan2('Weblog/HostingASP.NETinaWinForms.html');"><script type="text/javascript">postCount('Weblog/HostingASP.NETinaWinForms.html');</script></a>
  </BLOCKQUOTE>
      <P></P>

<div class="copyright">Site contents copyright 2001-2002 by John Lam. No animals were harmed during the production of this site. Some assembly required. Your mileage may vary. Use at your own risk.</div>
</td>
<td class="right_panel"></td>
</tr>
</table>
</BODY>
</HTML>
