<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Less is better</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  
  <link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.iunknown.com/xml/rsd" />
  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://feeds.feedburner.com/LessIsBetter" />
  <script src="/javascripts/cookies.js?1156231406" type="text/javascript"></script>
  <script src="/javascripts/prototype.js?1156231406" type="text/javascript"></script>
  <script src="/javascripts/effects.js?1156231406" type="text/javascript"></script>
  <script src="/javascripts/typo.js?1156231406" type="text/javascript"></script>
  
  <script type="text/javascript"></script>
  <link href="/stylesheets/theme/application.css?1164503575" media="all" rel="Stylesheet" type="text/css" />
  <script src="http://www.google-analytics.com/urchin.js" type="text/javascript"></script>
  <script type="text/javascript">
    _uacct="UA-133590-1";
    urchinTracker();
  </script>
</head>

<body>
<div id="container">
  <div id="header">
    <h1><span><a href="/">Less is better</a></span></h1>
    <h2>John Lam on software</h2>
  </div>

  <div id="page">
    <div id="content">
      <div class="atomentry" id="article-48">
  <h2 class="title">
    <a href="/articles/2005/12/23/ben-and-us">Ben and us</a> 
    
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-23T21:39:00-08:00"><span class="typo_date" title="Sat, 24 Dec 2005 05:39:00 GMT">Sat, 24 Dec 2005 05:39:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>A <strong>big</strong> thanks to everyone who sent along their best wishes to us!</p>


	<p>Carolyn made it out of the hospital much quicker (24 hours) than the last time around. She&#8217;s also feeling much stronger than she did after Matthew&#8217;s birth.</p>


	<p>Fortunately, since Ben&#8217;s birthday is so close to Christmas, we&#8217;ve got a house full of family to help us out as we adjust to having a toddler, a baby, a dog (and four other adults!) under the same roof.</p>


	<p><strong>Update:</strong> Here&#8217;s a photo of Ben that I made this afternoon:</p>


	<p><a href="http://www.flickr.com/photos/23649168@N00/sets/1629635/"><img src="http://static.flickr.com/37/76962122_f7218c18ce.jpg?v=0" alt="" /></a></p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/personal" rel="tag">Life</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/23/ben-and-us#comments">no comments</a>,
      <a href="/articles/2005/12/23/ben-and-us" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/48/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/48/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/23/ben-and-us">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/23/ben-and-us;title=Ben and us">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-47">
  <h2 class="title">
    <a href="/articles/2005/12/21/introducing-benjamin-peter-lam">Introducing Benjamin Peter Lam</a> 
    <span class="comment_count">9</span>
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-21T13:58:00-08:00"><span class="typo_date" title="Wed, 21 Dec 2005 21:58:00 GMT">Wed, 21 Dec 2005 21:58:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>Say hello to our new boy Ben! He was born Wednesday December 21, 2005 at 9:02AM.</p>


	<p><a href="http://static.flickr.com/43/75988270_5248165125.jpg?v=0"><img src="http://static.flickr.com/43/75988270_5248165125.jpg?v=0" alt="" /></a></p>


	<p>Here are a few more photos from his <a href="http://www.flickr.com/photos/23649168@N00/sets/1629635/">flickr photostream</a>.</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/personal" rel="tag">Life</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/21/introducing-benjamin-peter-lam#comments">9 comments</a>,
      <a href="/articles/2005/12/21/introducing-benjamin-peter-lam" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/47/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/47/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/21/introducing-benjamin-peter-lam">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/21/introducing-benjamin-peter-lam;title=Introducing Benjamin Peter Lam">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-45">
  <h2 class="title">
    <a href="/articles/2005/12/19/dreamhost-for-22-usd-first-year">Dreamhost for $22 USD first year</a> 
    
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-19T10:16:00-08:00"><span class="typo_date" title="Mon, 19 Dec 2005 18:16:00 GMT">Mon, 19 Dec 2005 18:16:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>I have a confession to make: I&#8217;m addicted to <a href="http://www.redflagdeals.com">Red Flag Deals</a>. Thanks to their forums, I&#8217;ve gotten more than my fair share of good deals. One deal that I thought I&#8217;d pass along here is <a href="http://www.dreamhost.com">Dreamhost</a> hosting package for only $22 <span class="caps">USD</span> for the first year on a new registration.</p>


	<p>This is an <em>insanely</em> good deal. With that you get a free year&#8217;s registration on a domain name of your choice, 4.8GB disk space, and 120GB / month transfer. You can create shell accounts, host an unlimited number of MySQL databases, and of course run <a href="http://www.rubyonrails.com">Rails</a> web sites as well.</p>


	<p>Here&#8217;s a link to the <a href="http://www.redflagdeals.com/forums/showthread.php?t=230288">original deal page</a> on  RedFlagDeals so that the props can go out to the appropriate folks.</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/links" rel="tag">Props</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/19/dreamhost-for-22-usd-first-year#comments">no comments</a>,
      <a href="/articles/2005/12/19/dreamhost-for-22-usd-first-year" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/45/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/45/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/19/dreamhost-for-22-usd-first-year">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/19/dreamhost-for-22-usd-first-year;title=Dreamhost for $22 USD first year">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-44">
  <h2 class="title">
    <a href="/articles/2005/12/17/clr-object-lifetime">CLR object lifetime</a> 
    
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-17T16:55:00-08:00"><span class="typo_date" title="Sun, 18 Dec 2005 00:55:00 GMT">Sun, 18 Dec 2005 00:55:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>My Ruby <span class="caps">CLR</span> bridge works by creating, on the fly, small <span class="caps">CIL</span> shims that invoke the appropriate method(s) on a <span class="caps">CLR</span> object. Today I want to talk about how I manage the lifetimes of those <span class="caps">CIL</span> shims.</p>


	<p>When you execute some code like <code>a = ArrayList.new</code> for the first time, I construct a new <code>ArrayList</code> Ruby class object on the fly. When you execute a method on a class instance such as <code>a.Sort</code>, I construct a <span class="caps">CIL</span> shim that knows how to invoke the <code>Sort</code> method on the <code>ArrayList</code> object. That <span class="caps">CIL</span> shim is bound to the Ruby class object via a call to <code>rb_define_method</code>.</p>


	<p>The <span class="caps">CIL</span> shim is created using the <code>DynamicMethod</code> API in <span class="caps">CLR 2</span>.0. After I finish defining the body of the dynamic method using my <code>RbDynamicMethod</code> API, I construct a delegate object that represents that method. These delegate objects are eligible for garbage collection, which means that I need to keep a reference to them. Now, when I said that the <span class="caps">CIL</span> shim is bound to the Ruby class object, Ruby only knows about the function pointer to the delegate object that represents the <span class="caps">CIL</span> shim. That function pointer is only a <em>weak reference</em> to the delegate, which means that it cannot keep the delegate object from being collected by the <span class="caps">CLR GC</span>.</p>


	<p>To work around this problem, I&#8217;ve added a <code>List&lt;Delegate&gt;</code> object to the Ruby class object. Its job is to hold onto references to all of the dynamically created <span class="caps">CIL</span> shim delegate objects <em>for that class</em>. When the Ruby class object is garbage collected by <em>Ruby&#8217;s GC</em>, my automagical object reference cleanup code will <code>Free</code> the <code>GCHandle</code> object that I use to keep a reference to the <code>List&lt;Delegate&gt;</code> object.</p>


	<p>I actually had a far more complicated and convoluted mechanism for dealing with this problem in my initial implementation of the bridge. I&#8217;m much happier with the simplicity of this approach in V2.</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/thoughts" rel="tag">Thoughts</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/17/clr-object-lifetime#comments">no comments</a>,
      <a href="/articles/2005/12/17/clr-object-lifetime" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/44/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/44/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/17/clr-object-lifetime">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/17/clr-object-lifetime;title=CLR object lifetime">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-43">
  <h2 class="title">
    <a href="/articles/2005/12/16/mindbinders">MindBinders</a> 
    <span class="comment_count">2</span>
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-16T22:04:00-08:00"><span class="typo_date" title="Sat, 17 Dec 2005 06:04:00 GMT">Sat, 17 Dec 2005 06:04:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>I was looking for a source of Moleskine notebooks in Toronto (Indigo is one place to get them, but they were sold out), and I stumbled across this photo via Technorati:</p>


	<p><img src="http://static.flickr.com/37/74193300_858dd5127d.jpg?v=0" alt="" /></p>


	<p>When I was in grad school, I spent a lot of time creating index cards; I had several thousand by the time I was done. <a href="http://www.mindbinders.com/products/products.html">These</a> look like a really nice way to replicate some of that goodness in a nice, compact form factor.</p>


	<p>I love the depth of field on his Sony Cybershot camera (shot at F/2).</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/links" rel="tag">Props</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/16/mindbinders#comments">2 comments</a>,
      <a href="/articles/2005/12/16/mindbinders" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/43/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/43/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/16/mindbinders">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/16/mindbinders;title=MindBinders">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-42">
  <h2 class="title">
    <a href="/articles/2005/12/16/how-meta-can-you-go">How meta can you go?</a> 
    
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-16T14:34:00-08:00"><span class="typo_date" title="Fri, 16 Dec 2005 22:34:00 GMT">Fri, 16 Dec 2005 22:34:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>I just figured out what Ruby was doing, because I forgot just how &#8220;meta&#8221; my programming was. Consider this code frag:</p>


<pre><code>
def const_missing(symbol)
  alias_const_missing(symbol) unless symbol == :ArrayList

  obj = create_clr_class_object
  # remember that the code below is in a string
  obj.class_eval %{
    def initialize(*params)
      create_safe_ruby_instance_method(
        self.class, 'initialize') do
        include     'System.Collections'
        declare     "#{symbol}", :obj
        ...
</code></pre>

	<p>Look at the last line of code and the <code>declare</code> statement. Notice how I&#8217;m referencing the <code>symbol</code> variable that is the input parameter to the <code>const_missing</code> method declaration on the first line? I have to escape that reference as a string to access that variable. Why? Because that code is embedded in a string (that&#8217;s what the funny <code>%{</code> means: it&#8217;s a begin string quotation symbol).</p>


	<p>Now this has interesting implications for other string manipulation functions that are inside of the <em>string</em> that is passed to <code>obj.class_eval</code>. For example consider this snippet of code.</p>


<pre><code>
sigs          = get_constructor_signatures("#{symbol}")
switch_labels = (1..sigs.length).collect { |i| ("l" + i.to_s).to_sym }
</code></pre>

	<p>I <em>really</em> wanted to write the string expression as:</p>


	<p><code>"l#{i}".to_sym</code></p>


	<p>But this cannot work since it would try and find an <code>i</code> variable defined in the enclosing method. So I wound up writing it in the somewhat more verbose way that I did to make it work. I wound up scratching my head about this behavior for quite a while before I realized that, doh! the code was executing <em>inside of a string</em>.</p>


	<p>That&#8217;s how powerful Ruby&#8217;s metaprogramming facilities are: oftentimes you forget that you&#8217;re really programming at a meta level of abstraction instead of at the &#8220;concrete&#8221; level.</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/thoughts" rel="tag">Thoughts</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/16/how-meta-can-you-go#comments">no comments</a>,
      <a href="/articles/2005/12/16/how-meta-can-you-go" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/42/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/42/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/16/how-meta-can-you-go">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/16/how-meta-can-you-go;title=How meta can you go?">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-41">
  <h2 class="title">
    <a href="/articles/2005/12/15/refactoring-cil">Refactoring CIL</a> 
    <span class="comment_count">2</span>
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-15T17:33:00-08:00"><span class="typo_date" title="Fri, 16 Dec 2005 01:33:00 GMT">Fri, 16 Dec 2005 01:33:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>I had a great day today. I had one of those a-ha experiences where you get to benefit from an earlier decision in ways that you did not expect. I started down the path of generating constructor shims using <code>RbDynamicMethod</code>. I completed my first spike yesterday, when I successfully constructed <code>ArrayList</code> objects using <code>RbDynamicMethod</code>.</p>


	<p>Today, I wanted to make a slightly more generic constructor shim that would let me call both a default and a single argument constructor: <code>ArrayList()</code> and <code>ArrayList(Int32)</code>. While I was writing this code, I began to feel some <span class="caps">CIL</span> pain (it is, after all <strong>assembly language</strong>). So I did what came naturally: I began to refactor the code.</p>


	<p>This reminds me of the talk that I saw this year at <span class="caps">OOPSLA</span> where Ward Cunningham was refactoring assembly language using IntelliJ. In my case, I refactored <span class="caps">CIL</span> using emacs :) Here&#8217;s the end result:</p>


<pre><code>
def initialize(*params)
  create_ruby_instance_method(self.class, 'initialize') do
    include     'System.Collections'
    declare     "#{symbol}", :obj
    ldarg_0
    switch      [:zero_param, :one_param]
    br_s        :end_switch
    label       :zero_param
    newobj      '#{symbol}()'
    stloc_s     :obj
    br_s        :end_switch
    label       :one_param
    ld_rb_param 0, 'Int32'
    newobj      '#{symbol}(Int32)'
    stloc_s     :obj
    label       :end_switch
    ret_objref  :obj
  end
  initialize(*params)
end
</code></pre>

	<p>While this is mostly <span class="caps">CIL</span>, it also contains a number of macros and fun Ruby string stuff. The macros that I used are: <code>ld_rb_param</code>, <code>ret_objref</code>. As it turns out, these will be very common code fragments that will be used throughout the bridge. Writing those macros was even easier. Here&#8217;s a sample:</p>


<pre><code>
module RbDynamicMethodHelpers
  def ld_self
    ldarg_2
  end

  def ld_rb_param(index, type)
    ldarg_1
    case index
    when 1:
      ldc_i4_4
      add
    when 2:
      ldc_i4_8
      add
    else
      ldc_i4    index &lt;&lt; 2
      add
    end
    ldind_i4
    call      "static Marshal::To#{type}(VALUE)" 
  end

  def ret_objref(local_variable_name)
    ld_self
    ldloc_s  local_variable_name
    call     'static Marshal::AssignToClassInstance(VALUE, Object)'
    ret
  end
end
</pre></code>

	<p>It turned out it was a good thing that I left the method declarations as strings, since I could do some simple string manipulation to inject implement syntactic sugar methods such as <code>ld_rb_param</code> (which is actually a very efficient <span class="caps">CIL</span> implementation that is optimized for the common cases).</p>


	<p>Oh yeah, how much extra code did I have to add to <code>RbDynamicMethod</code> to enable macros? I changed:</p>


	<p><code>object.extend RbDynamicMethod</code></p>


	<p>to:</p>


	<p><code>object.extend RbDynamicMethod, RbDynamicMethodHelpers</code></p>


	<p>Did I mention how much I love Ruby? :)</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/thoughts" rel="tag">Thoughts</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/15/refactoring-cil#comments">2 comments</a>,
      <a href="/articles/2005/12/15/refactoring-cil" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/41/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/41/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/15/refactoring-cil">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/15/refactoring-cil;title=Refactoring CIL">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-40">
  <h2 class="title">
    <a href="/articles/2005/12/14/hello-rubyclr">Hello RubyClr</a> 
    <span class="comment_count">1</span>
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-14T21:57:00-08:00"><span class="typo_date" title="Thu, 15 Dec 2005 05:57:00 GMT">Thu, 15 Dec 2005 05:57:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>I spent most of yesterday and today hacking out the first spike of the Ruby rewrite of my original Ruby to <span class="caps">CLR</span> bridge. I wound up adding some additional code to <code>RbDynamicMethod</code> to support some scenarios that I didn&#8217;t envision (nothing like having a &#8216;customer&#8217; to reveal deficiencies in an <span class="caps">API</span>!). I also spent a <strong>lot</strong> of time learning about how objects are constructed in Ruby. Here&#8217;s a very simplified explanation of Ruby&#8217;s object model; for a complete description, see Chapter 24 of Dave Thomas&#8217; excellent <a href="http://www.amazon.com/exec/obidos/ASIN/0974514055/ref=nosim/iunknowncom-20">Programming Ruby</a>.</p>


	<p><br>
<a href="http://www.amazon.com/exec/obidos/ASIN/0974514055/ref=nosim/iunknowncom-20"><img src="http://images.amazon.com/images/P/0974514055.01._AA240_SCLZZZZZZZ_.jpg" alt="" /></a>
<br></p>


	<p>In Ruby, objects are instances of classes. However, classes are also objects in Ruby, which means that a class is an instance of a class called <code>Class</code>. Let&#8217;s consider the following code fragment:</p>


<pre><code>
a = ArrayList.new
puts a.Count
</code></pre>

	<p>In the first line, we&#8217;ve created an instance of class <code>ArrayList</code> and assigned it to the variable <code>a</code>. Next, we invoke the <code>Count</code> instance method of the <code>ArrayList</code> object. So far so good, right?</p>


	<p>Next let&#8217;s see how Ruby invokes instance methods. Every Ruby object contains a reference to its class object. This is stored in an internal field called <code>klass</code>. When we invoke the <code>Count</code> method on the <code>ArrayList</code> object, Ruby follows the <code>klass</code> reference to find the <code>ArrayList</code> class object. It searches its method table, finds the <code>Count</code> method and invokes it.</p>


	<p>In my bridge, I delay binding to a method on a <span class="caps">CLR</span> object until it is called. When it is called, I build a small piece of <span class="caps">CIL</span> code using <code>RbDynamicMethod</code> to call the method and marshal data back to the caller. I can delay binding to the method using the <code>method_missing</code> instance method of the object. In the case of the call to the <code>Count</code> method, you could imagine a piece of code that looks like:</p>


<pre><code>
alias alias_method_missing method_missing

def method_missing(name, *params)
  alias_method_missing(name, *params) unless name == :Count

  create_ruby_instance_method(self.class, 'Count') do
    include  'System.Collections'
    ldarg_2
    call     'static Marshal::ToClrObject(VALUE)'
    call     'ArrayList::get_Count()'
    call     'static Marshal::ToRubyNumber(Int32)'
    ret
  end
  self.Count
end
</code></pre>

	<p>This is a hard-coded example that generates a shim for the <code>Count</code> method. The shim invokes the <code>get_Count</code> method to retrieve the value of the <code>Count</code> property of the <code>ArrayList</code> object. It marshals the return value (an <code>Int32</code>) back to the caller using the <code>Marshal::ToRubyNumber()</code> helper method in the <code>RbDynamicMethod</code> library.</p>


	<p>Where things get interesting is the first two lines of <span class="caps">CIL</span> code in the shim. Here, I reach into the Ruby object and pull out the actual <code>ArrayList</code> object reference that is stored in a <em>secret</em> field of the Ruby object. This secret field is completely inaccessible to Ruby code. Once I have the object reference, I can freely invoke the <code>get_Count</code> instance method using the <span class="caps">CIL</span> <code>call</code> instruction.</p>


	<p>Notice that I&#8217;m defining an instance method called <code>Count</code> on the <code>ArrayList</code> class object. At the end of the <code>method_missing</code> method, I invoke the <code>Count</code> method that I just defined. However, all <em>subsequent</em> calls to the <code>Count</code> instance method will go directly to the <span class="caps">CIL</span> code that I just wrote (which of course will have been compiled into x86 code as well). This means that we will have excellent performance since we completely avoid having to use the <code>Reflection</code> APIs in the <span class="caps">CLR</span>.</p>


	<p>You&#8217;re probably wondering how the <code>ArrayList</code> object reference got stored in the secret field? I&#8217;ll talk about that in tomorrow&#8217;s installment of the story when we look at how objects get created in Ruby (and it&#8217;s nowhere near as simple as it looks!).</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/thoughts" rel="tag">Thoughts</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/14/hello-rubyclr#comments">1 comment</a>,
      <a href="/articles/2005/12/14/hello-rubyclr" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/40/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/40/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/14/hello-rubyclr">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/14/hello-rubyclr;title=Hello RubyClr">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-39">
  <h2 class="title">
    <a href="/articles/2005/12/13/democamp">DemoCamp</a> 
    <span class="comment_count">1</span>
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-13T00:31:00-08:00"><span class="typo_date" title="Tue, 13 Dec 2005 08:31:00 GMT">Tue, 13 Dec 2005 08:31:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>I went to <a href="http://barcamp.org/index.cgi?SignUpHere">DemoCamp</a> tonight and I saw a bunch of cool demos put on by folks working on startups here in Toronto.</p>


	<ul>
	<li>The <a href="http://www.bubbleshare.com">BubbleShare</a> folks had a really cool demo of an upcoming feature of their photo sharing service. They&#8217;ve implemented the core interface of iPhoto using <span class="caps">AJAX</span> (you know the one: dragging a slider that dynamically resizes the thumbnails). You have to see it to believe it. Apparently this feature goes live on their site next week sometime.</li>
		<li>If you&#8217;re into ego surfing, you should definitely check out <a href="http://ehlist.ca/">Eh List</a>. Chris Nolan&#8217;s done a really good job of aggregating a bunch of services to show you just where you rank (or don&#8217;t) in the blogosphere.</li>
		<li>I&#8217;m continually amazed by how Randy Charles Morin is able to generate revenue from his various ventures. Tonight he demonstrated <a href="http://www.r-mail.org/">RMail</a> which is a service that emails you <span class="caps">RSS</span> feeds. Randy monetizes this by including links within the blog entries that point back to his custom search engine.</li>
		<li>Sutha Kamal of <a href="http://www.ambientvector.com">Ambient Vector</a> demonstrated his social collaborative search engine that improves the quality of mobile search based on its analysis of your preferences and <em>your peer group&#8217;s preferences</em>. This is a really powerful idea that greatly improves the quality of recommendations, since you can think of search results as recommendations. This ties back into the idea that providing search context is a good thing.</li>
	</ul>


	<p>It was also cool to hang out with <a href="http://www.braithwaite-lee.com/weblog/">Reg Braithwaite</a> again. Tonight I got a great idea about building a Firefox extension based on his ideas about context-based recommendations. I <em>so</em> want to do something cool in this space.</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/links" rel="tag">Props</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/13/democamp#comments">1 comment</a>,
      <a href="/articles/2005/12/13/democamp" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/39/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/39/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/13/democamp">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/13/democamp;title=DemoCamp">reddit</a>
    </li>
  </ul>
</div>
<div class="atomentry" id="article-38">
  <h2 class="title">
    <a href="/articles/2005/12/13/third-drop-of-rbdynamicmethod">Third drop of RbDynamicMethod</a> 
    <span class="comment_count">2</span>
  </h2>

  <p class="author">
    Posted by <cite><a href="mailto:jlam@iunknown.com">John Lam</a></cite>
    <abbr class="published" title="2005-12-13T00:23:00-08:00"><span class="typo_date" title="Tue, 13 Dec 2005 08:23:00 GMT">Tue, 13 Dec 2005 08:23:00 GMT</span></abbr>
  </p>

  <div class="content">
    <p>Here&#8217;s <a href="/images/RbDynamicMethod.zip">another drop</a> of <code>RbDynamicMethod</code>. New to this release is a custom implementation of <code>Type.GetMethod</code> that correctly finds overloaded generic methods. The .NET implementation of this method does not support resolving generic methods, so I wound up rolling my own. If you&#8217;re interested in its implementation you should check out <code>FindGenericMethodTemplate</code> in the sources.</p>


	<p>This is what using <code>RbDynamicMethod</code> to call a generic method looks like:</p>


<pre><code>
create_ruby_module_function(RbDynamicMethod, 'call_generic_min_method') do
  include   'RbDynamicMethodTests'
  ldc_i4_3
  ldc_i4_2
  call      'static GenericMethodTests::Min&lt;Int32&gt;(Int32, Int32)'
  call      'static Marshal::ToRubyNumber(Int32)'
  ret
end
assert_equal 2, call_generic_min_method
</code></pre>

	<p>This should be the last drop of this library for the next little while since I think it&#8217;s good enough to begin building my new Ruby to <span class="caps">CLR</span> bridge on top of it.</p>

      
  </div>

  <ul class="meta">
    <li class="categories">Posted in <a href="/articles/category/thoughts" rel="tag">Thoughts</a></li>
    
    <li>Meta 
      
      <a href="/articles/2005/12/13/third-drop-of-rbdynamicmethod#comments">2 comments</a>,
      <a href="/articles/2005/12/13/third-drop-of-rbdynamicmethod" rel="bookmark">permalink</a>,
      <a href="http://www.iunknown.com/xml/rss/article/38/feed.xml">rss</a>,    
      <a href="http://www.iunknown.com/xml/atom/article/38/feed.xml">atom</a>, 
      <a title='digg this' href="http://digg.com/submit?phase=2&url=/articles/2005/12/13/third-drop-of-rbdynamicmethod">digg this</a>, 
      <a title='reddit' href="http://reddit.com/submit?url=/articles/2005/12/13/third-drop-of-rbdynamicmethod;title=Third drop of RbDynamicMethod">reddit</a>
    </li>
  </ul>
</div>


<p class="pagination">Older posts: 1 <a href="/articles/2005/12/page/2">2</a> <a href="/articles/2005/12/page/3">3</a> </p>

      <script type="text/javascript">
//<![CDATA[
show_dates_as_local_time()
//]]>
</script>
    </div>

    <div id="sidebar">
      <!-- search -->
      <div id="search" class="search">
	<form action="/articles/search" id="sform" method="get">
	  <p><input type="text" id="q" name="q" value="" /></p>
	</form>
	
	<div id="loading" class="loading" style="display:none;">Searching...</div>
	<div id="results" class="results"></div>
  <script type="text/javascript">
//<![CDATA[
new Form.Element.Observer('q', 1, function(element, value) {new Ajax.Updater('results', '/live/search', {asynchronous:true, evalScripts:true, onComplete:function(request){Element.hide('loading')}, onLoading:function(request){Element.show('loading')}, parameters:'q=' + escape($F('q'))})})
//]]>
</script>
</div>


      <!-- sidebar components -->
      
      
<div class="sidebar-node">
  <h3>John Lam</h3>
<a href="/pages/about_me"><img src="http://static.flickr.com/90/222479189_d4e19a202c_t.jpg" width="67" height="100" alt="Self portrait" /></a>

<p>I am a Program Manager on the Common Language Runtime team at Microsoft. I write .NET and Ruby code on a Mac. I'm the creator of <a href="http://www.rubyclr.com">RubyCLR</a>, a high performance bridge between Ruby and .NET. <a href="/pages/about_me">More ...</a>

<table>
<tr>
  <td>email:</td>
  <td>jlam@iunknown.com</td>
</tr>
<tr>
  <td>phone:</td>
  <td>425 698 9332</td>
</tr>
<tr>
  <td>msn:</td>
  <td>drjflam@hotmail.com</td>
</tr>
<tr>
  <td>gtalk:</td>
  <td>drjflam@gmail.com</td>
</tr>
</table>
<br>
<h3>Syndicate</h3>

<p><a href="http://feeds.feedburner.com/LessIsBetter"><img src="/images/rss.png"/></a>&nbsp;
<a href="http://feeds.feedburner.com/LessIsBetter"><img src="http://feeds.feedburner.com/~fc/LessIsBetter?bg=FF9900&amp;fg=000000&amp;anim=0" height="26" width="88" style="border:0" alt="" /></a>
<br>
<form style="padding:3px;text-align:left;" action="http://www.feedburner.com/fb/a/emailverify" method="post" target="popupwindow" onsubmit="window.open('http://www.feedburner.com', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true"><p>Subscribe by email:</p><p><input type="text" style="width:140px" name="email"/></p><input type="hidden" value="http://feeds.feedburner.com/~e?ffid=180551" name="url"/><input type="hidden" value="Less is better" name="title"/><input type="submit" value="Subscribe" /><p>Delivered by <a href="http://www.feedburner.com/" target="_blank">FeedBurner</a></p></form>

</div>


      
<div class="sidebar-node">
    <div id="delicious">
    <h3><a href="http://del.icio.us/drjflam">del.icio.us/drjflam</a></h3>
            <ul>
      
      <li>
        <a href="http://www.people.iup.edu/pnwm/comparison.gif" title="Fun comparison of fictional starships from different SF shows.">Starship size comparison chart</a>
              </li>
      
      <li>
        <a href="http://www.teach12.com/" title="Bill Gates listens to the lectures from this company - available as downloads as well.">The Teaching Company</a>
              </li>
      
      <li>
        <a href="http://www.speedtest.net/" title="Found this via StumbleUpon">Speedtest.net - The Global Broadband Speed Test</a>
              </li>
      
      <li>
        <a href="http://wvs.topleftpixel.com/flash/cntower_timelapse.swf" title="Move your mouse around this picture and see it change.">Downtown Toronto Photo</a>
              </li>
      
      <li>
        <a href="ftp://gatekeeper.dec.com/pub/DEC/WRL/research-reports/WRL-TR-95.7.pdf" title="">Shared Memory Consistency Models</a>
              </li>
      
      <li>
        <a href="http://discuss.develop.com/archives/wa.exe?A2=ind0203B&amp;L=DOTNET&amp;P=R375" title="An excellent discussion on the motivation for and implementation of the CLR memory model.">Vance Morrison on CLR Memory Model</a>
              </li>
      
      <li>
        <a href="http://slideshare.net/" title="A YouTube like service for sharing slides from talks.">SlideShare</a>
              </li>
      
      <li>
        <a href="http://research.microsoft.com/manuvir/papers/instruction_level_tracing_VEE06.pdf" title="This is MSR's Nirvana framework for dynamically injecting tracing code into x86 binaries at runtime. It lets them travel forwards and backwards in execution flow ('time travel debugging').">Framework for Instruction-level Tracing and Analysis of Program Executions</a>
              </li>
      
      <li>
        <a href="http://www.macgeekery.com/hacks/software/video/how_to_view_tivo_recordings_on_your_mac_or_ipod" title="Looking forward to setting this up ...">How to View TiVo Recordings on Your Mac or iPod</a>
              </li>
      
      <li>
        <a href="http://uneasysilence.com/archive/2006/12/8602/" title="Wow - this is really nice seamless integration - Windows apps appearing to run as 'top-level' windows on Mac OS X desktop.">Parallels running IE7 &amp; Firefox on Mac OS X desktop!</a>
              </li>
      
      <li>
        <a href="http://www.ldc.upenn.edu/Catalog/CatalogEntry.jsp?catalogId=LDC2006T13" title="Google recently released their collection of 1-grams (single word frequency) to 5-grams (5 word frequency) as a 24GB compressed gzip'd file.">Google's collection of 1-5 grams</a>
              </li>
          </ul>
      </div>

</div>


      
<div class="sidebar-node">
  <h3>My Photos</h3>
<style type="text/css">
.zg_div {margin:0px 5px 5px 0px; width:117px;}
.zg_div_inner {background-color:#ffffff;  color:#666666; text-align:center; font-family:arial, helvetica; font-size:11px;}
.zg_div a, .zg_div a:hover, .zg_div a:visited {color:#3993ff; background:inherit !important; text-decoration:none !important;}
</style>
<script type="text/javascript">
zg_insert_badge = function() {
var zg_bg_color = 'ffffff';
var zgi_url = 'http://www.flickr.com/apps/badge/badge_iframe.gne?zg_bg_color='+zg_bg_color+'&zg_person_id=23649168%40N00';
document.write('<iframe style="background-color:#'+zg_bg_color+'; border-color:#'+zg_bg_color+'; border:none;" width="113" height="151" frameborder="0" scrolling="no" src="'+zgi_url+'" title="Flickr Badge"><\/iframe>');
if (document.getElementById) document.write('<div id="zg_whatlink"><a href="http://www.flickr.com/badge_new.gne"	style="color:#3993ff;" onclick="zg_toggleWhat(); return false;">what is this?<\/a><\/div>');
}
zg_toggleWhat = function() {
document.getElementById('zg_whatdiv').style.display = (document.getElementById('zg_whatdiv').style.display != 'none') ? 'none' : 'block';
document.getElementById('zg_whatlink').style.display = (document.getElementById('zg_whatdiv').style.display != 'none') ? 'none' : 'block';
return false;
}
</script>
<div class="zg_div"><div class="zg_div_inner"><a href="http://www.flickr.com">www.<strong style="color:#3993ff">flick<span style="color:#ff1c92">r</span></strong>.com</a><br>
<script type="text/javascript">zg_insert_badge();</script>
<div id="zg_whatdiv">This is a Flickr badge showing public photos from <a href="http://www.flickr.com/photos/23649168@N00">John Lam</a>. Make your own badge <a href="http://www.flickr.com/badge_new.gne">here</a>.</div>
<script type="text/javascript">if (document.getElementById) document.getElementById('zg_whatdiv').style.display = 'none';</script>
</div>
</div>

</div>


      
<div class="sidebar-node">
  
<h3>Archives</h3>
<ul id="archives">
  
    <li>
      <a href="/articles/2007/2">February 2007</a>
      <em>(1)</em>
    </li>
  
    <li>
      <a href="/articles/2007/1">January 2007</a>
      <em>(4)</em>
    </li>
  
    <li>
      <a href="/articles/2006/12">December 2006</a>
      <em>(2)</em>
    </li>
  
    <li>
      <a href="/articles/2006/11">November 2006</a>
      <em>(2)</em>
    </li>
  
    <li>
      <a href="/articles/2006/10">October 2006</a>
      <em>(8)</em>
    </li>
  
    <li>
      <a href="/articles/2006/9">September 2006</a>
      <em>(12)</em>
    </li>
  
    <li>
      <a href="/articles/2006/8">August 2006</a>
      <em>(39)</em>
    </li>
  
    <li>
      <a href="/articles/2006/7">July 2006</a>
      <em>(29)</em>
    </li>
  
    <li>
      <a href="/articles/2006/6">June 2006</a>
      <em>(23)</em>
    </li>
  
    <li>
      <a href="/articles/2006/5">May 2006</a>
      <em>(34)</em>
    </li>
  
    <li>
      <a href="/articles/2006/4">April 2006</a>
      <em>(13)</em>
    </li>
  
    <li>
      <a href="/articles/2006/3">March 2006</a>
      <em>(21)</em>
    </li>
  
    <li>
      <a href="/articles/2006/2">February 2006</a>
      <em>(25)</em>
    </li>
  
    <li>
      <a href="/articles/2006/1">January 2006</a>
      <em>(9)</em>
    </li>
  
    <li>
      <a href="/articles/2005/12">December 2005</a>
      <em>(22)</em>
    </li>
  
    <li>
      <a href="/articles/2005/11">November 2005</a>
      <em>(17)</em>
    </li>
  
    <li>
      <a href="/articles/2005/10">October 2005</a>
      <em>(6)</em>
    </li>
  
</ul>


</div>


      
<div class="sidebar-node">
  <h3>Tags</h3>
<p style="overflow:hidden">
<span style="font-size:66.6666666666667%"><a href="/articles/tag/barcampearthtoronto">BarCampEarthToronto</a></span>
<span style="font-size:129.87012987013%"><a href="/articles/tag/dynamiclanguages">DynamicLanguages</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/ironpython">IronPython</a></span>
<span style="font-size:103.896103896104%"><a href="/articles/tag/life">Life</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/mac">Mac</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/marketing">Marketing</a></span>
<span style="font-size:77.9220779220779%"><a href="/articles/tag/microsoft">Microsoft</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/parenting">Parenting</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/photography">Photography</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/platforms">Platforms</a></span>
<span style="font-size:200%"><a href="/articles/tag/props">Props</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/python">Python</a></span>
<span style="font-size:200%"><a href="/articles/tag/ruby">Ruby</a></span>
<span style="font-size:200%"><a href="/articles/tag/rubyclr">RubyCLR</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/rubyconf">RubyConf</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/secondlife">SecondLife</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/simplicity">simplicity</a></span>
<span style="font-size:200%"><a href="/articles/tag/thoughts">Thoughts</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/vim">Vim</a></span>
<span style="font-size:66.6666666666667%"><a href="/articles/tag/workspaces">workspaces</a></span>
</p>


</div>


      
<div class="sidebar-node">
  <h3>Categories</h3>
<ul id="categories">
  
  <li><a href="/articles/category/personal">Life</a> <em>(20)</em></li>
  
  
  <li><a href="/articles/category/links">Props</a> <em>(58)</em></li>
  
  
  <li><a href="/articles/category/thoughts">Thoughts</a> <em>(148)</em></li>
  
</ul>


</div>


  


    </div>
    <br style="clear:both;" />
  </div>

  <div id="footer">
    <hr />
    <p><a href="/">Less is better</a></p>
    <ul>
      <li>powered by <a href="http://typosphere.org">typo</a> /
          styled with <a href="http://quotedprintable.com/pages/scribbish">scribbish</a></li>
    </ul>
  </div>
</div>
</body>
</html>
