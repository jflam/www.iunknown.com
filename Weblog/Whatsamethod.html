<!-- Published by Fog Creek Software CityDesk CQSXKDXJHSYDVISL/5193B323/181 -->


<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>What's a method?</title>
  <link rel="stylesheet" href="../iunknown.css"/>
  <script type="text/javascript" src="http://www.haloscan.com/load.php?user=jlam"></script>
  <script language="javascript">
    function HaloScan2( id ) {
      location.href='http://www.haloscan.com/comments.php?user=jlam&comment='+id;
    }
  </script>
</head>
<body>
  <a href="http://www.iunknown.com"><img src="../Images/iunknown.png" width="350" height="60" border="0"></a> 
  <table width="700px" border="0" cellspacing="10">
    <tr>
      <td width="76%" valign="top">
        <div class="entryTitle">What's a method?</div>
        <div class="entryDate">2002-06-28</div>
        <p><P>This morning, I decided to investigate how the CLR treats methods. First, here's some background information; there are at least three different pieces of information that describe a method in the CLR:</P>
<UL>
<LI>MethodDef tokens describe the <EM>definition</EM> of a method within the scope of the module that it was defined. MethodDef tokens are always scoped by the module in which it was defined. In reality a MethodDef token is simply an the row number of the corresponding entry into the MethodDef table of a module. MethodDef tokens are static data; they are generated at compile time. 
<LI>FunctionID's are provided by the CLR to profilers. The profiler API documentation describes it as&nbsp;"an opaque 32-bit handle". They are used to identify a function that is being called. For example, the ICorProfilerCallback::JITCompilationStarted() callback passes a FunctionID as an in-parameter. FunctionID's are global in scope - that is they are not tied to a specific module.[1] FunctionID's are dynamic data; they are generated at runtime by the CLR. 
<LI>RuntimeMethodHandles are managed structures that are used by the System.Reflection API's to locate a method. Typically you pass a RuntimeMethodHandle to the static MethodInfo.GetMethodFromHandle() method to retrieve a MethodInfo object that corresponds to the runtime method. RuntimeMethodHandles are also dynamic data generated by the CLR.</LI></UL>
<P>There are a number of different ways that you can convert between these values. Some are available if you're using the profiling API's, others are available to you if you're writing IL.</P>
<P>The profiling API's provide some helper methods that let you map a FunctionID to a MethodDef token and a MethodDef token to a FunctionID. These helper methods are ICorProfilerInfo::GetFunctionInfo(), which returns a ModuleID and MethodDef token given a FunctionID, and ICorProfilerInfo::GetFunctionFromToken(), which returns you a FunctionID given a ModuleID and a MethodDef token.</P>
<P>IL lets you retrieve a RuntimeMethodHandle object reference for a MethodDef token <EM>within the currently executing module</EM>, using the ldtoken instruction. This instruction takes a MethodDef token on the call stack and replaces it with a reference to a RuntimeMethodHandle value type.</P>
<P>With that background out of the way, let's get to the point of this entry: Is there a difference between FunctionID's and RuntimeMethodHandles? In the old days, I would figure this out by sending some email to friends at Microsoft who knew how such things behaved. But nowadays there's a much better (and generally faster[2]) way to figure these things out: use the Rotor sources.</P>
<P><A href="http://staff.develop.com/jasonw/">Jason Whittington's</A> <A href="http://msdn.microsoft.com/msdnmag/issues/02/07/SharedSourceCLI/default.asp">Introduction to Rotor article in MSDN</A> helped greatly in getting thins setup and making sense of the Rotor build environment. Once I had a debug build up and running, I started spelunking around inside the SSCLI using the VS.NET debugger. It didn't take much time to figure out that FunctionID's mapped to MethodDesc structs in the CLR. Next, there was a comment in RuntimeMethodHandle.cs that said: "This corresponds to EE MethodDesc.". Hmmm ... it doesn't take a rocket scientist to make the connection, huh?</P>
<P>Just to make sure, though, I also compiled and built a couple of test rigs that would find out for sure. In one case, I used the Reflection API's to scrape out the RuntimeMethodHandle method for a the static Main() method in a console application:</P><CODE>
<P>namespace rmh<BR>{<BR>&nbsp; class Class1<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; [STAThread]<BR>&nbsp;&nbsp;&nbsp; public static void Main(string[] args)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Get a handle to this method</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type class1 = Type.GetType( "rmh.Class1" );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodInfo main = class1.GetMethod( "Main", BindingFlags.Static | BindingFlags.Public );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RuntimeMethodHandle handle = main.MethodHandle;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Handle == {0}", handle.Value );<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</P></CODE>
<P>Then I made a special build of CLAW that dumped out the FunctionID's to the debug console window. The code in question is:</P><CODE>
<P>STDMETHODIMP JITCompilationStarted( FunctionID functionId, BOOL fIsSafeToBlock ) <BR>{ <BR>&nbsp; ATLTRACE( "JIT started on function id = %p", functionId );<BR>&nbsp; return S_OK; <BR>}</P></CODE>
<P>As it turns out, the method handles match up perfectly, thus demonstrating (at least in this case) that a RuntimeMethodHandle's m_ptr field == FunctionID == MethodDesc*.[3]</P>
<P>[1] I'm not currently sure about what the scope of FunctionID's are. They&nbsp;are likely scoped on a per-managed process basis. But I need to do some more experiments to find out for sure.</P>
<P>[2] The email culture at Microsoft is one of getting hundreds of emails a day. If I can help reduce this load, I will, so that I can save up some karma points for help with really difficult questions ;)</P>
<P>[3] Yes, I know I really should have written more code to dump out the method name using the unmanaged metadata API's, but I'll leave that as an exercise for the reader.</P><img src="../Images/blue_button.jpg" alt="Permanent Link" width="18" height="18" align="top"></p>
        <a href="javascript:HaloScan2('Weblog/Whatsamethod.html');"><script type="text/javascript">postCount('Weblog/Whatsamethod.html');</script></a>
      </td>
      <td width="24%" valign="top">
        <a href="http://www.iunknown.com/rss.xml"><img src="../Images/xml.png" width="36" height="14" border="0"></a>
  
        <p><img src="../Images/about.png" width="100" height="25"></p>
        <div class="aboutEntry"> 
          
            <A href="../About/Aboutme.html">About me</A><br>
          
            <A href="../About/fog0000000006.html">About this site</A><br>
          
            <A href="../About/fog0000000010.html">My plan</A><br>
          
            <A href="../About/fog0000000009.html">My other life</A><br>
          
            <A href="../About/fog0000000008.html">My products</A><br>
          
            <A href="../About/fog0000000013.html">My publications</A><br>
          
        </div>

        <p><img src="../Images/archives.png" width="100" height="25"></p>
        <div class="archiveEntry">
         
           <A href="../Archives/April2003.html">April 2003</A><br>
         
           <A href="../Archives/March2003.html">March 2003</A><br>
         
           <A href="../Archives/February2003.html">February 2003</A><br>
         
           <A href="../Archives/January2003.html">January 2003</A><br>
         
           <A href="../Archives/December2002.html">December 2002</A><br>
         
           <A href="../Archives/November2002.html">November 2002</A><br>
         
           <A href="../Archives/October2002.html">October 2002</A><br>
         
           <A href="../Archives/September2002.html">September 2002</A><br>
         
           <A href="../Archives/August2002.html">August 2002</A><br>
         
           <A href="../Archives/July2002.html">July 2002</A><br>
         
           <A href="../Archives/June2002.html">June 2002</A><br>
         
           <A href="../Archives/May2002.html">May 2002</A><br>
         
           <A href="../Archives/April2002.html">April 2002</A><br>
         
           <A href="../Archives/fog0000000116.html">March 2002</A><br>
         
           <A href="../Archives/fog0000000091.html">February 2002</A><br>
         
           <A href="../Archives/fog0000000046.html">January 2002</A><br>
         
           <A href="../Archives/fog0000000030.html">December 2001</A><br>
         
        </div>

        <p><img src="../Images/articles.png" width="100" height="25"></p>
        <div class="articleEntry">
          
            - <A href="../Articles/Booksuggestions.html">Book suggestions</A><br>
          
            - <A href="../Articles/fog0000000082.html">Interface dispatch vs. object reference dispatch</A><br>
          
            - <A href="../Articles/fog0000000065.html">x86 Resources</A><br>
          
            - <A href="../Articles/fog0000000041.html">Entertainment PC's Part 2</A><br>
          
            - <A href="../Articles/fog0000000034.html">Entertainment PC's</A><br>
          
            - <A href="../Articles/fog0000000025.html">Hello CppUnit</A><br>
          
        </div>

        <p><img src="../Images/links.png" width="100" height="25"></p>
        <div class="linkEntry">
          <a href="http://www.gotdotnet.com/team/dbox/spoutlet.aspx">Don Box</a><br>
          <a href="http://www.stronglytyped.com/">Richard Caetano</a><br>
          <a href="http://www.razorsoft.net/weblog/">Peter Drayton</a><br>
          <a href="http://radio.weblogs.com/0109845/">Jeroen Frijters</a><br>
          <a href="http://radio.weblogs.com/0105852/">Sam Gentile</a><br>
          <a href="http://radio.weblogs.com/0106747/">Scott Hanselman</a><br>
          <a href="http://radio.weblogs.com/0104813/">Drew Marsh</a><br>
          <a href="http://www.dotnetremoting.cc/dotnetcentric/">Ingo Rammer</a><br>
          <a href="http://www.winterdom.com/weblog/">Tomas Restrepo</a><br>
          <a href="http://www.sellsbrothers.com/">Chris Sells</a><br>
          <a href="http://www.joelonsoftware.com/">Joel Spolsky</a><br>
          <a href="http://radio.weblogs.com/0108971/">Clemens Vasters</a><br>
          <a href="http://staff.develop.com/jasonw/weblog/">Jason Whittington</a><br>
          <a href="http://dotnetguy.techieswithcats.com/">Brad Wilson</a><br>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
