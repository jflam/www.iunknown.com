<!-- Published by Fog Creek Software CityDesk CQSXKDXJHSYDVISL/5193B323/110 -->


<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>Multi-module assemblies</title>
  <link rel="stylesheet" href="../iunknown.css"/>
  <script type="text/javascript" src="http://www.haloscan.com/load.php?user=jlam"></script>
  <script language="javascript">
    function HaloScan2( id ) {
      location.href='http://www.haloscan.com/comments.php?user=jlam&comment='+id;
    }
  </script>
</head>
<body>
  <a href="http://www.iunknown.com"><img src="../Images/iunknown.png" width="350" height="60" border="0"></a> 
  <table width="700px" border="0" cellspacing="10">
    <tr>
      <td width="76%" valign="top">
        <div class="entryTitle">Multi-module assemblies</div>
        <div class="entryDate">2002-02-25</div>
        <p><P>OK. I've got a confession to make: I've never written a multi-module assembly. But then again, you probably haven't written one of these either, right? Come on, admit it. There's no shame in it ;)</P>
<P>Today, I actually had to create one of these things so that I could examine the effects that multi-module assemblies would have on my runtime aspect weaver. Before we get there, let's quickly review the difference between a module and an assembly.</P>
<P><A href="http://msdn.microsoft.com/library/en-us/cpguide/html/cpconassembliesoverview.asp?frame=true">Assemblies are&nbsp;defined</A> quite nicely in the Framework SDK documentation. You can refer to the documentation for details, but I'm going to define an assembly as a <EM>logical</EM> module, where a module is a classic Win32 PE file. I call it a logical module because it can be composed of one or more <EM>physical</EM> modules that are bound together through an <A href="http://msdn.microsoft.com/library/en-us/cpguide/html/cpconassemblymanifest.asp?frame=true">assembly manifest</A>.</P>
<P>Most modules that you are likely to encounter (such as the Framework SDK assemblies) are single module assemblies. The manifest, metadata, code, and resources all live inside of a single Win32 PE file. </P>
<P>However, there are cases where some other developer wanted to combine code that was written using different programming languages into a single assembly. To do this, she would instruct her compilers to compile the code into a <EM>module</EM>, rather than an assembly. Once that was done, she would generate the assembly manifest that binds the modules together into a logical assembly using the assembly linker tool. </P>
<P>This is best illustrated by an example. In our example, we will create a multi-module assembly that contains both C# and VB.NET code.</P>
<P>Here's the C# code:</P>
<P><CODE>using System;</P>
<P>namespace Module1<BR>{<BR>&nbsp; public class AClassInModule1<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; public static void SayHello()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Hello from Module1" );<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</CODE></P>
<P>To tell the C# compiler to compile this code into a module instead of an assembly, you would have to issue the following command from your command prompt:</P>
<P><CODE>csc /t:module module1.cs</CODE></P>
<P>Note that the compiler generated a new file called module1.netmodule. The default filename extension for all .NET modules is .netmodule.</P>
<P>Here's the VB.NET code:</P>
<P><CODE>Imports System</P>
<P>Namespace Module2</P>
<P>&nbsp; Public Class AClassInModule2<BR>&nbsp; <BR>&nbsp;&nbsp;&nbsp; Public Shared Sub SayHello()<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine( "Hello from VB Module2" )<BR>&nbsp;&nbsp;&nbsp; End Sub</P>
<P>&nbsp; End Class</P>
<P>End Namespace<BR></CODE></P>
<P>To tell the VB.NET compiler to compile this code into a module instead of an assembly, you would have to issue the following command from your command prompt:</P>
<P><CODE>vbc /t:module module2.vb</CODE></P>
<P>The VB.NET compiler generated a new file called module2.netmodule.</P>
<P>To generate the manifest that binds the two modules that we created earlier, we need to use the assembly linker utility (AL.EXE). Here's the command that generates a DLL that contains the assembly manifest:</P>
<P><CODE>al /t:lib /out:master.dll module1.netmodule module2.netmodule</CODE></P>
<P>If you look at the manifest that is generated by AL.EXE using ILDASM, you'll see the following (edited) manifest:</P>
<P><CODE>// Deleted extern assembly references <BR>.assembly master<BR>{<BR>&nbsp; //&nbsp;Deleted DebuggableAttribute comment<BR>&nbsp; .hash algorithm 0x00008004<BR>&nbsp; .ver 0:0:0:0<BR>}<BR>.file Module1.netmodule<BR>&nbsp; //&nbsp;Deleted hash<BR>.file Module2.netmodule<BR>&nbsp; //&nbsp;Deleted hash<BR>.class extern public Module1.AClassInModule1<BR>{<BR>&nbsp; .file Module1.netmodule<BR>&nbsp; .class 0x02000002<BR>}<BR>.class extern public Module2.AClassInModule2<BR>{<BR>&nbsp; .file Module2.netmodule<BR>&nbsp; .class 0x02000002<BR>}<BR>.module master.dll<BR>// MVID: {6DBAEEA8-9B41-436A-A7F8-2A4824175652}<BR>.imagebase 0x00400000<BR>.subsystem 0x00000003<BR>.file alignment 512<BR>.corflags 0x00000001<BR>// Image base: 0x02ee0000</CODE></P>
<P>The manifest reveals several interesting things:</P>
<UL>
<LI>
<DIV>The .file declarations identify the two .netmodule files that were created by the csc.exe and vbc.exe compilers. </DIV>
<LI>
<DIV>All public types must be explicitly exported from those modules using the .class extern declarations. </DIV>
<LI>
<DIV>The .class extern declarations map the name of the Type to the module that it was implemented in and its TypeDef token value. </DIV>
<LI>
<DIV>An interesting observation: the two exported types have the same TypeDef token value: 0x02000002. This should not be surprising since TypeDef tokens are scoped by the <EM>module</EM> that they are defined in and not by the <EM>assembly</EM> that they are found in.</DIV></LI></UL>
<P>Why does all of this information exist? To make it possible for the execution engine to resolve type references at runtime. You may not know this, but the runtime always resolves types based on their full names (namespace + name).[1] When a compiler needs to generate code to call a method on one of our exported types, it needs to generate a reference to that type. That reference must contains the referenced type's full name. At runtime, when the execution engine attempts to locate the referenced type, it needs to consult the master.dll's manifest to resolve the type name to a module + TypeDef token for the referenced type. </P>
<P>This opens up a potentially nasty can of worms for the developer who created the two modules in the first place. Since&nbsp;the two modules were compiled independently of each other, the possibility of a name conflict exists. Since each compiler has no knowledge of the other module being compiled, it cannot inform her of a name collision at compile time. </P>
<P>You would expect that the assembly linker would at least warn you of an impending name collision, right? Wrong. It silently picks the type from the first module and exports that type only.&nbsp;Be careful!</P>
<P>Enough introductory stuff. In a future entry in this web log, I'll discuss why I had to create this multi-module assembly in the first place. As it turns out, writing this entry really helped me solidify my understanding of the more arcane details of multi-module assemblies. This is another reason for me to <A href="fog0000000109.html">maintain this web log</A>: there is no better way to really understand something than by trying to explain it to somebody else. </P>
<P>As always, please feel free to <A href="mailto:jlam@iunknown.com">send comments my way</A>.</P>
<P>[1] Namespaces are a work of fiction; the runtime does not have any knowledge of namespaces, they are just created by the compilers to ease the burden on developers.</P><img src="../Images/blue_button.jpg" alt="Permanent Link" width="18" height="18" align="top"></p>
        <a href="javascript:HaloScan2('Weblog/fog0000000110.html');"><script type="text/javascript">postCount('Weblog/fog0000000110.html');</script></a>
      </td>
      <td width="24%" valign="top">
        <a href="http://www.iunknown.com/rss.xml"><img src="../Images/xml.png" width="36" height="14" border="0"></a>
  
        <p><img src="../Images/about.png" width="100" height="25"></p>
        <div class="aboutEntry"> 
          
            <A href="../About/Aboutme.html">About me</A><br>
          
            <A href="../About/fog0000000006.html">About this site</A><br>
          
            <A href="../About/fog0000000010.html">My plan</A><br>
          
            <A href="../About/fog0000000009.html">My other life</A><br>
          
            <A href="../About/fog0000000008.html">My products</A><br>
          
            <A href="../About/fog0000000013.html">My publications</A><br>
          
        </div>

        <p><img src="../Images/archives.png" width="100" height="25"></p>
        <div class="archiveEntry">
         
           <A href="../Archives/April2003.html">April 2003</A><br>
         
           <A href="../Archives/March2003.html">March 2003</A><br>
         
           <A href="../Archives/February2003.html">February 2003</A><br>
         
           <A href="../Archives/January2003.html">January 2003</A><br>
         
           <A href="../Archives/December2002.html">December 2002</A><br>
         
           <A href="../Archives/November2002.html">November 2002</A><br>
         
           <A href="../Archives/October2002.html">October 2002</A><br>
         
           <A href="../Archives/September2002.html">September 2002</A><br>
         
           <A href="../Archives/August2002.html">August 2002</A><br>
         
           <A href="../Archives/July2002.html">July 2002</A><br>
         
           <A href="../Archives/June2002.html">June 2002</A><br>
         
           <A href="../Archives/May2002.html">May 2002</A><br>
         
           <A href="../Archives/April2002.html">April 2002</A><br>
         
           <A href="../Archives/fog0000000116.html">March 2002</A><br>
         
           <A href="../Archives/fog0000000091.html">February 2002</A><br>
         
           <A href="../Archives/fog0000000046.html">January 2002</A><br>
         
           <A href="../Archives/fog0000000030.html">December 2001</A><br>
         
        </div>

        <p><img src="../Images/articles.png" width="100" height="25"></p>
        <div class="articleEntry">
          
            - <A href="../Articles/Booksuggestions.html">Book suggestions</A><br>
          
            - <A href="../Articles/fog0000000082.html">Interface dispatch vs. object reference dispatch</A><br>
          
            - <A href="../Articles/fog0000000065.html">x86 Resources</A><br>
          
            - <A href="../Articles/fog0000000041.html">Entertainment PC's Part 2</A><br>
          
            - <A href="../Articles/fog0000000034.html">Entertainment PC's</A><br>
          
            - <A href="../Articles/fog0000000025.html">Hello CppUnit</A><br>
          
        </div>

        <p><img src="../Images/links.png" width="100" height="25"></p>
        <div class="linkEntry">
          <a href="http://www.gotdotnet.com/team/dbox/spoutlet.aspx">Don Box</a><br>
          <a href="http://www.stronglytyped.com/">Richard Caetano</a><br>
          <a href="http://www.razorsoft.net/weblog/">Peter Drayton</a><br>
          <a href="http://radio.weblogs.com/0109845/">Jeroen Frijters</a><br>
          <a href="http://radio.weblogs.com/0105852/">Sam Gentile</a><br>
          <a href="http://radio.weblogs.com/0106747/">Scott Hanselman</a><br>
          <a href="http://radio.weblogs.com/0104813/">Drew Marsh</a><br>
          <a href="http://www.dotnetremoting.cc/dotnetcentric/">Ingo Rammer</a><br>
          <a href="http://www.winterdom.com/weblog/">Tomas Restrepo</a><br>
          <a href="http://www.sellsbrothers.com/">Chris Sells</a><br>
          <a href="http://www.joelonsoftware.com/">Joel Spolsky</a><br>
          <a href="http://radio.weblogs.com/0108971/">Clemens Vasters</a><br>
          <a href="http://staff.develop.com/jasonw/weblog/">Jason Whittington</a><br>
          <a href="http://dotnetguy.techieswithcats.com/">Brad Wilson</a><br>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
