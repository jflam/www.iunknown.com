<!-- Published by Fog Creek Software CityDesk CQSXKDXJHSYDVISL/5193B323/105 -->


<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>AOP demo code</title>
  <link rel="stylesheet" href="../iunknown.css"/>
  <script type="text/javascript" src="http://www.haloscan.com/load.php?user=jlam"></script>
  <script language="javascript">
    function HaloScan2( id ) {
      location.href='http://www.haloscan.com/comments.php?user=jlam&comment='+id;
    }
  </script>
</head>
<body>
  <a href="http://www.iunknown.com"><img src="../Images/iunknown.png" width="350" height="60" border="0"></a> 
  <table width="700px" border="0" cellspacing="10">
    <tr>
      <td width="76%" valign="top">
        <div class="entryTitle">AOP demo code</div>
        <div class="entryDate">2002-02-19</div>
        <p><P>I promised <A href="http://www.sellsbrothers.com">Chris Sells</A> that I would publish the sample code and output of my demos at VS Live!. </P>
<P>Here's the Main() method of the test application:</P>
<P><CODE>static int Main(string[] args)<BR>{<BR>&nbsp; Console.WriteLine( "Hello, World!" );<BR><BR>&nbsp; XmlDocument doc = new XmlDocument();<BR>&nbsp; doc.Load( @"c:\work\codexp\weavecompiler\wc\weavemanifest.xml" );&nbsp;&nbsp;<BR><BR>&nbsp; Math math = new Math();<BR>&nbsp; Console.WriteLine( Math.GetString( "Bar" ) );<BR>&nbsp; Console.WriteLine( "The answer is: " + math.Add( 3, 4 ) );<BR>&nbsp; Console.WriteLine( "Another call: " + math.Add( 1000, 2000 ) );<BR>&nbsp; Console.WriteLine( "Yet another call: " + math.Multiply( 3, 3, 3 ) );<BR><BR>&nbsp; return 0;<BR>}</CODE></P>
<P>Here's the user-defined type that was weaved in the first part of the demonstration:</P>
<P><CODE>public class Math<BR>{<BR>&nbsp; public static string GetString( string before )<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; return String.Format( "Before: {0}", before );<BR>&nbsp; }<BR>&nbsp; public int Add( int x, int y )<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; return x + y;<BR>&nbsp; }<BR>&nbsp; public int Multiply( int x, int y, int z )<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; return x * y;<BR>&nbsp; }<BR>}</CODE></P>
<P>The first demonstration that I showed at VS Live! weaved all of the methods of the Math class shown above. The aspect was defined in a separate assembly, and contains a single piece of advice: the Interceptor() method shown below. This method was weaved as before advice on an execution join-point (in plain English: the Interceptor method is called before any of the method bodies of the Math class methods are executed).</P>
<P><CODE>public class TraceAspect <BR>{<BR>&nbsp; private static TraceAspect m_this;<BR><BR>&nbsp; static TraceAspect()<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; m_this = new TraceAspect();<BR>&nbsp; }<BR>&nbsp; public static TraceAspect AspectOf() <BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; return m_this;<BR>&nbsp; }<BR>&nbsp; public void Interceptor( CallContext context )<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; string result = String.Format( "Intercepted: {0}( ", context.MethodName );<BR>&nbsp;&nbsp;&nbsp; if( context.Parameters != null )<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for( int i = 0; i &lt; context.Parameters.Length; i++ )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if( i != context.Parameters.Length - 1 )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result += String.Format( "{0}, ", context.Parameters[ i ] );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result += String.Format( "{0} )", context.Parameters[ i ] );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; result += ")";<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine( result );<BR>&nbsp; }<BR>}</CODE></P>
<P>The output that was generated by the first demonstration is:</P>
<P><CODE>Hello, World!<BR>Intercepted: GetString( Bar )<BR>Before: Bar<BR>Intercepted: Add( 3, 4 )<BR>The answer is: 7<BR>Intercepted: Add( 1000, 2000 )<BR>Another call: 3000<BR>Intercepted: Multiply( 3, 3, 3 )<BR>Yet another call: 9</CODE></P>
<P>The second demonstration showed weaving of methods that were defined in system libraries. I weaved all of the public methods of System.Xml.XmlDocument as well as System.Xml.XmlTextReader. The weave was defined in an external XML configuration file, which was fed through a weave compiler that generated a binary file that was used by the runtime aspect weaver to determine which methods to weave. Here is the weave definition file:</P>
<P><CODE>&lt;?xml version="1.0" encoding="utf-8" ?&gt; <BR>&lt;weave&gt;<BR>&nbsp; &lt;pointcut target="public.*System.Xml.XmlDocument.*\(" adviceType="before" advice="public void CallTrace.Trace\( CodeXP.CallContext \)" /&gt;<BR>&nbsp; &lt;pointcut target="public.*System.Xml.XmlTextReader.*\(" adviceType="before" advice="public void CallTrace.Trace\( CodeXP.CallContext \)" /&gt;<BR>&lt;/weave&gt;</CODE></P>
<P>The output of the second demonstration is:</P>
<P><CODE>Hello, World!<BR>Intercepted: Load( c:\work\codexp\weavecompiler\wc\weavemanifest.xml )<BR>Intercepted: get_NameTable( )<BR>Intercepted: get_NameTable( )<BR>Intercepted: get_BaseURI( )<BR>Intercepted: get_NameTable( )<BR>Intercepted: get_NameTable( )<BR>Intercepted: get_NameTable( )<BR>Intercepted: Load( System.Xml.XmlValidatingReader )<BR>...</CODE></P>
<P>Folks who are really interested in the entire output that was generated by the program can <A href="../Files/demo2.txt">look here</A>.</P>
<P>This represents the current state of the AOP engine. It can weave before advice into arbitrary methods in both user and system library code. Note that the syntax of the weave definition file is very much in flux right now. I might turn it into custom attributes that are embedded into the source code of the aspects.</P>
<P>Next up (after an extensive cleanup of the code) is after, around and exception advice weaving at execution join-points.&nbsp;Then comes the more difficult case:&nbsp;weaving advice into&nbsp;call join-points.</P>
<P>In case you are wondering where all of this terminology comes from, I'm lifting it from <A href="http://aspectj.org/doc/dist/progguide/apb.html#d0e3870">AspectJ</A>&nbsp;;)</P><img src="../Images/blue_button.jpg" alt="Permanent Link" width="18" height="18" align="top"></p>
        <a href="javascript:HaloScan2('Weblog/fog0000000105.html');"><script type="text/javascript">postCount('Weblog/fog0000000105.html');</script></a>
      </td>
      <td width="24%" valign="top">
        <a href="http://www.iunknown.com/rss.xml"><img src="../Images/xml.png" width="36" height="14" border="0"></a>
  
        <p><img src="../Images/about.png" width="100" height="25"></p>
        <div class="aboutEntry"> 
          
            <A href="../About/Aboutme.html">About me</A><br>
          
            <A href="../About/fog0000000006.html">About this site</A><br>
          
            <A href="../About/fog0000000010.html">My plan</A><br>
          
            <A href="../About/fog0000000009.html">My other life</A><br>
          
            <A href="../About/fog0000000008.html">My products</A><br>
          
            <A href="../About/fog0000000013.html">My publications</A><br>
          
        </div>

        <p><img src="../Images/archives.png" width="100" height="25"></p>
        <div class="archiveEntry">
         
           <A href="../Archives/April2003.html">April 2003</A><br>
         
           <A href="../Archives/March2003.html">March 2003</A><br>
         
           <A href="../Archives/February2003.html">February 2003</A><br>
         
           <A href="../Archives/January2003.html">January 2003</A><br>
         
           <A href="../Archives/December2002.html">December 2002</A><br>
         
           <A href="../Archives/November2002.html">November 2002</A><br>
         
           <A href="../Archives/October2002.html">October 2002</A><br>
         
           <A href="../Archives/September2002.html">September 2002</A><br>
         
           <A href="../Archives/August2002.html">August 2002</A><br>
         
           <A href="../Archives/July2002.html">July 2002</A><br>
         
           <A href="../Archives/June2002.html">June 2002</A><br>
         
           <A href="../Archives/May2002.html">May 2002</A><br>
         
           <A href="../Archives/April2002.html">April 2002</A><br>
         
           <A href="../Archives/fog0000000116.html">March 2002</A><br>
         
           <A href="../Archives/fog0000000091.html">February 2002</A><br>
         
           <A href="../Archives/fog0000000046.html">January 2002</A><br>
         
           <A href="../Archives/fog0000000030.html">December 2001</A><br>
         
        </div>

        <p><img src="../Images/articles.png" width="100" height="25"></p>
        <div class="articleEntry">
          
            - <A href="../Articles/Booksuggestions.html">Book suggestions</A><br>
          
            - <A href="../Articles/fog0000000082.html">Interface dispatch vs. object reference dispatch</A><br>
          
            - <A href="../Articles/fog0000000065.html">x86 Resources</A><br>
          
            - <A href="../Articles/fog0000000041.html">Entertainment PC's Part 2</A><br>
          
            - <A href="../Articles/fog0000000034.html">Entertainment PC's</A><br>
          
            - <A href="../Articles/fog0000000025.html">Hello CppUnit</A><br>
          
        </div>

        <p><img src="../Images/links.png" width="100" height="25"></p>
        <div class="linkEntry">
          <a href="http://www.gotdotnet.com/team/dbox/spoutlet.aspx">Don Box</a><br>
          <a href="http://www.stronglytyped.com/">Richard Caetano</a><br>
          <a href="http://www.razorsoft.net/weblog/">Peter Drayton</a><br>
          <a href="http://radio.weblogs.com/0109845/">Jeroen Frijters</a><br>
          <a href="http://radio.weblogs.com/0105852/">Sam Gentile</a><br>
          <a href="http://radio.weblogs.com/0106747/">Scott Hanselman</a><br>
          <a href="http://radio.weblogs.com/0104813/">Drew Marsh</a><br>
          <a href="http://www.dotnetremoting.cc/dotnetcentric/">Ingo Rammer</a><br>
          <a href="http://www.winterdom.com/weblog/">Tomas Restrepo</a><br>
          <a href="http://www.sellsbrothers.com/">Chris Sells</a><br>
          <a href="http://www.joelonsoftware.com/">Joel Spolsky</a><br>
          <a href="http://radio.weblogs.com/0108971/">Clemens Vasters</a><br>
          <a href="http://staff.develop.com/jasonw/weblog/">Jason Whittington</a><br>
          <a href="http://dotnetguy.techieswithcats.com/">Brad Wilson</a><br>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
