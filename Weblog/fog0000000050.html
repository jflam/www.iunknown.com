<!-- Published by Fog Creek Software CityDesk CQSXKDXJHSYDVISL/5193B323/50 -->


<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>Parameter arrays</title>
  <link rel="stylesheet" href="../iunknown.css"/>
  <script type="text/javascript" src="http://www.haloscan.com/load.php?user=jlam"></script>
  <script language="javascript">
    function HaloScan2( id ) {
      location.href='http://www.haloscan.com/comments.php?user=jlam&comment='+id;
    }
  </script>
</head>
<body>
  <a href="http://www.iunknown.com"><img src="../Images/iunknown.png" width="350" height="60" border="0"></a> 
  <table width="700px" border="0" cellspacing="10">
    <tr>
      <td width="76%" valign="top">
        <div class="entryTitle">Parameter arrays</div>
        <div class="entryDate">2002-01-04</div>
        <p><P>I love <A href="../About/Aboutme.html">my day job</A>. It lets me explore all sorts of weird nooks and crannies inside the CLR and it gives me an opportunity to share what I found with you. That's fun.</P>
<P>Today's topic is parameter arrays. They are described in Section 10.5.1.4 of the C# Language Specification. Today, I needed a quick and dirty way to cruft up an object that would hold an arbitrary number of values, each of which could be a different type. I turned to parameter arrays for the solution. As it turns out, parameter arrays are simply some syntactic sugar that the C# compiler uses to hide a bit of ugliness from you. </P>
<P>Consider this code frag:</P>
<P><CODE>class Values <BR>{ <BR>&nbsp; private object[] _parameters; <BR>&nbsp; public Values( params object[] parameters ) <BR>&nbsp; { <BR>&nbsp;&nbsp;&nbsp; _parameters = new object[ parameters.Length ]; <BR>&nbsp;&nbsp;&nbsp; parameters.CopyTo( _parameters, 0 ); <BR>&nbsp; } <BR>}</CODE></P>
<P>Notice the constructor accepts a parameter array of object parameters. Now let's consider a method that passes a bunch of values to the Values constructor:</P>
<P><CODE>public static int Add( int x, int y, string[] args ) <BR>{ <BR>&nbsp; Values values = new Values( x, y, args ); <BR>&nbsp; return x + y; <BR>} </CODE></P>
<P>If we use ILDASM to examine the CIL that is generated by the C# compiler, this is what we see:</P>
<P><CODE>.method public hidebysig static int32&nbsp;Add(int32 x,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int32 y,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string[] args) cil managed<BR>{<BR>&nbsp; // Code size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 40 (0x28)<BR>&nbsp; .maxstack&nbsp; 3<BR>&nbsp; .locals init ([0] object[] values)<BR><BR>// Values values = new Values( x, y, args );</CODE><CODE><BR><BR>&nbsp; IL_0000:&nbsp; ldc.i4.3<BR>&nbsp; IL_0001:&nbsp; newarr&nbsp;&nbsp;&nbsp;&nbsp; [mscorlib]System.Object<BR>&nbsp; IL_0006:&nbsp; stloc.0<BR>&nbsp; IL_0007:&nbsp; ldloc.0<BR>&nbsp; IL_0008:&nbsp; ldc.i4.0<BR>&nbsp; IL_0009:&nbsp; ldarg.0<BR>&nbsp; IL_000a:&nbsp; box&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [mscorlib]System.Int32<BR>&nbsp; IL_000f:&nbsp; stelem.ref<BR>&nbsp; IL_0010:&nbsp; ldloc.0<BR>&nbsp; IL_0011:&nbsp; ldc.i4.1<BR>&nbsp; IL_0012:&nbsp; ldarg.1<BR>&nbsp; IL_0013:&nbsp; box&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [mscorlib]System.Int32<BR>&nbsp; IL_0018:&nbsp; stelem.ref<BR>&nbsp; IL_0019:&nbsp; ldloc.0<BR>&nbsp; IL_001a:&nbsp; ldc.i4.2<BR>&nbsp; IL_001b:&nbsp; ldarg.2<BR>&nbsp; IL_001c:&nbsp; stelem.ref<BR>&nbsp; IL_001d:&nbsp; ldloc.0<BR>&nbsp; IL_001e:&nbsp; newobj&nbsp;&nbsp;&nbsp;&nbsp; instance void ParameterArrays.Values::.ctor(object[])<BR>&nbsp; IL_0023:&nbsp; pop<BR><BR>// return x + y;<BR><BR>&nbsp; IL_0024:&nbsp; ldarg.0<BR>&nbsp; IL_0025:&nbsp; ldarg.1<BR>&nbsp; IL_0026:&nbsp; add<BR>&nbsp; IL_0027:&nbsp; ret<BR>} // end of method Class1::ExplicitAdd<BR></P></CODE>
<P>Note that this code was compiled using the /optimize switch so we see the <EM>real</EM> CIL, and <A href="fog0000000049.html">not the wierd crap</A> that is generated to make debuggers happy.</P>
<P>As you can see, the C# compiler generated quite a bit of code for the call to the Values constructor. All this code does is create an object array with three elements, stuff the values of x, y and args into those elements, and pass a reference to that object array to the Values constructor. Note that since we are passing an <EM>object</EM> array, it is necessary to box the integer values x and y prior to stuffing them in the parameter array. </P>
<P>In fact, the original Add() method is identical to the following ExplicitAdd() method that manually constructs an object array:</P>
<P><CODE>public static int ExplicitAdd( int x, int y, string[] args ) <BR>{ <BR>&nbsp; object[] values = new object[ 3 ]; <BR>&nbsp; values[ 0 ] = x;&nbsp;<BR>&nbsp;&nbsp;values[ 1 ] = y; <BR>&nbsp; values[ 2 ] = args; <BR>&nbsp; Values data = new Values( values ); <BR>&nbsp; return x + y;<BR>}</CODE></P>
<P>Run this code through your C# compiler; you will see that it generates exactly the same CIL. There are other places in C# where the compiler generates a bunch of code to hide ugliness from you. The way delegates are handled is an example of this. I'll cover that in a future entry.</P><img src="../Images/blue_button.jpg" alt="Permanent Link" width="18" height="18" align="top"></p>
        <a href="javascript:HaloScan2('Weblog/fog0000000050.html');"><script type="text/javascript">postCount('Weblog/fog0000000050.html');</script></a>
      </td>
      <td width="24%" valign="top">
        <a href="http://www.iunknown.com/rss.xml"><img src="../Images/xml.png" width="36" height="14" border="0"></a>
  
        <p><img src="../Images/about.png" width="100" height="25"></p>
        <div class="aboutEntry"> 
          
            <A href="../About/Aboutme.html">About me</A><br>
          
            <A href="../About/fog0000000006.html">About this site</A><br>
          
            <A href="../About/fog0000000010.html">My plan</A><br>
          
            <A href="../About/fog0000000009.html">My other life</A><br>
          
            <A href="../About/fog0000000008.html">My products</A><br>
          
            <A href="../About/fog0000000013.html">My publications</A><br>
          
        </div>

        <p><img src="../Images/archives.png" width="100" height="25"></p>
        <div class="archiveEntry">
         
           <A href="../Archives/April2003.html">April 2003</A><br>
         
           <A href="../Archives/March2003.html">March 2003</A><br>
         
           <A href="../Archives/February2003.html">February 2003</A><br>
         
           <A href="../Archives/January2003.html">January 2003</A><br>
         
           <A href="../Archives/December2002.html">December 2002</A><br>
         
           <A href="../Archives/November2002.html">November 2002</A><br>
         
           <A href="../Archives/October2002.html">October 2002</A><br>
         
           <A href="../Archives/September2002.html">September 2002</A><br>
         
           <A href="../Archives/August2002.html">August 2002</A><br>
         
           <A href="../Archives/July2002.html">July 2002</A><br>
         
           <A href="../Archives/June2002.html">June 2002</A><br>
         
           <A href="../Archives/May2002.html">May 2002</A><br>
         
           <A href="../Archives/April2002.html">April 2002</A><br>
         
           <A href="../Archives/fog0000000116.html">March 2002</A><br>
         
           <A href="../Archives/fog0000000091.html">February 2002</A><br>
         
           <A href="../Archives/fog0000000046.html">January 2002</A><br>
         
           <A href="../Archives/fog0000000030.html">December 2001</A><br>
         
        </div>

        <p><img src="../Images/articles.png" width="100" height="25"></p>
        <div class="articleEntry">
          
            - <A href="../Articles/Booksuggestions.html">Book suggestions</A><br>
          
            - <A href="../Articles/fog0000000082.html">Interface dispatch vs. object reference dispatch</A><br>
          
            - <A href="../Articles/fog0000000065.html">x86 Resources</A><br>
          
            - <A href="../Articles/fog0000000041.html">Entertainment PC's Part 2</A><br>
          
            - <A href="../Articles/fog0000000034.html">Entertainment PC's</A><br>
          
            - <A href="../Articles/fog0000000025.html">Hello CppUnit</A><br>
          
        </div>

        <p><img src="../Images/links.png" width="100" height="25"></p>
        <div class="linkEntry">
          <a href="http://www.gotdotnet.com/team/dbox/spoutlet.aspx">Don Box</a><br>
          <a href="http://www.stronglytyped.com/">Richard Caetano</a><br>
          <a href="http://www.razorsoft.net/weblog/">Peter Drayton</a><br>
          <a href="http://radio.weblogs.com/0109845/">Jeroen Frijters</a><br>
          <a href="http://radio.weblogs.com/0105852/">Sam Gentile</a><br>
          <a href="http://radio.weblogs.com/0106747/">Scott Hanselman</a><br>
          <a href="http://radio.weblogs.com/0104813/">Drew Marsh</a><br>
          <a href="http://www.dotnetremoting.cc/dotnetcentric/">Ingo Rammer</a><br>
          <a href="http://www.winterdom.com/weblog/">Tomas Restrepo</a><br>
          <a href="http://www.sellsbrothers.com/">Chris Sells</a><br>
          <a href="http://www.joelonsoftware.com/">Joel Spolsky</a><br>
          <a href="http://radio.weblogs.com/0108971/">Clemens Vasters</a><br>
          <a href="http://staff.develop.com/jasonw/weblog/">Jason Whittington</a><br>
          <a href="http://dotnetguy.techieswithcats.com/">Brad Wilson</a><br>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
